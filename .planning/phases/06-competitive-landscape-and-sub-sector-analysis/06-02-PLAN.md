---
phase: 06-competitive-landscape-and-sub-sector-analysis
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/sections/deep-dive/SubSectorDeepDive.tsx
  - src/sections/deep-dive/CostBreakdownChart.tsx
  - src/sections/deep-dive/CostBreakdownTable.tsx
  - src/sections/deep-dive/MarginLevers.tsx
  - src/sections/deep-dive/TopQuartileAnalysis.tsx
  - src/sections/deep-dive/SubSectorHeader.tsx
autonomous: true

must_haves:
  truths:
    - "User sees the current month's sub-sector name prominently displayed (e.g., 'Air Conditioning')"
    - "User sees a horizontal stacked bar chart showing COGS breakdown by cost item with share percentages"
    - "User sees a cost breakdown table with cost item, share %, trend direction, and detailed notes"
    - "User sees margin levers ranked by impact (bps) with feasibility badges and explanation"
    - "User sees top-quartile analysis comparing top, median, and bottom quartile values per metric with top performers listed"
    - "Data is NOT filtered by company filter (sector-wide sub-segment analysis)"
  artifacts:
    - path: "src/sections/deep-dive/SubSectorDeepDive.tsx"
      provides: "Main Sub-Sector Deep Dive section with sub-sector header and all sub-components"
      min_lines: 35
    - path: "src/sections/deep-dive/CostBreakdownChart.tsx"
      provides: "Horizontal stacked bar chart for COGS breakdown"
      min_lines: 25
    - path: "src/sections/deep-dive/CostBreakdownTable.tsx"
      provides: "Detailed cost breakdown table with trend indicators"
      min_lines: 30
    - path: "src/sections/deep-dive/MarginLevers.tsx"
      provides: "Margin levers ranked by impact with feasibility badges"
      min_lines: 30
    - path: "src/sections/deep-dive/TopQuartileAnalysis.tsx"
      provides: "Top-quartile vs median vs bottom-quartile comparison"
      min_lines: 30
    - path: "src/sections/deep-dive/SubSectorHeader.tsx"
      provides: "Sub-sector name and context header"
      min_lines: 10
  key_links:
    - from: "src/sections/deep-dive/SubSectorDeepDive.tsx"
      to: "src/hooks/use-filtered-data.ts"
      via: "useFilteredData('deep-dive')"
      pattern: "useFilteredData.*deep-dive"
    - from: "src/sections/deep-dive/MarginLevers.tsx"
      to: "src/components/ui/ConfidenceBadge.tsx"
      via: "ConfidenceBadge for feasibility level"
      pattern: "ConfidenceBadge"
    - from: "src/sections/deep-dive/CostBreakdownTable.tsx"
      to: "src/components/ui/TrendIndicator.tsx"
      via: "TrendIndicator for cost trend direction"
      pattern: "TrendIndicator"
---

<objective>
Build the Sub-Sector Deep Dive section -- a rotating monthly deep dive into one sub-segment (e.g., Air Conditioning) with cost structure benchmarks, margin lever analysis, and top-quartile performance comparison.

Purpose: Users need to understand what drives profitability differences within specific sub-segments and which companies are best-in-class.

Output: Fully rendered Sub-Sector Deep Dive section replacing the Phase 2 placeholder, with cost breakdown visualization, margin levers, and quartile analysis.
</objective>

<execution_context>
@/Users/prateekkurkanji/.claude/get-shit-done/workflows/execute-plan.md
@/Users/prateekkurkanji/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/types/sections.ts
@src/data/mock/deep-dive.ts
@src/hooks/use-filtered-data.ts
@src/components/ui/StatCard.tsx
@src/components/ui/TrendIndicator.tsx
@src/components/ui/ConfidenceBadge.tsx
@src/components/ui/PerformanceTag.tsx
@src/components/charts/BarComparisonChart.tsx
@src/lib/formatters.ts
@src/theme/tokens.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build Sub-Sector Deep Dive section with cost breakdown, margin levers, and quartile analysis</name>
  <files>src/sections/deep-dive/SubSectorDeepDive.tsx, src/sections/deep-dive/CostBreakdownChart.tsx, src/sections/deep-dive/CostBreakdownTable.tsx, src/sections/deep-dive/MarginLevers.tsx, src/sections/deep-dive/TopQuartileAnalysis.tsx, src/sections/deep-dive/SubSectorHeader.tsx</files>
  <action>
Replace the Phase 2 placeholder in `SubSectorDeepDive.tsx` with a full Sub-Sector Deep Dive section. Create sub-components for each analysis area. The main component must retain `export default function SubSectorDeepDive()` (React.lazy requires default export).

**SubSectorDeepDive.tsx** (main orchestrator):
- Keep `useFilteredData<SubSectorDeepDiveData>("deep-dive")`, loading/error/null handling, and header with `DataRecencyTag`.
- Remove placeholder content and `getActiveFilterSummary` helper.
- Layout:
  ```
  <div className="p-md space-y-md">
    {/* Header row with title + DataRecencyTag */}
    <SubSectorHeader subSector={data.subSector} />
    {/* Cost structure section */}
    <div className="grid grid-cols-3 gap-md">
      <div className="col-span-1">
        <CostBreakdownChart costs={data.costsBreakdown} />
      </div>
      <div className="col-span-2">
        <CostBreakdownTable costs={data.costsBreakdown} />
      </div>
    </div>
    {/* Analysis sections in 2-column grid */}
    <div className="grid grid-cols-2 gap-md">
      <MarginLevers levers={data.marginLevers} />
      <TopQuartileAnalysis metrics={data.topQuartileAnalysis} />
    </div>
  </div>
  ```

**SubSectorHeader.tsx**:
- Props: `{ subSector: string }`
- Render: `<div className="bg-brand-primary/5 border border-brand-primary/20 rounded p-sm">` with sub-sector name as `text-sm font-semibold text-brand-primary` and subtitle "Monthly Deep Dive" in `text-xs text-text-secondary`.

**CostBreakdownChart.tsx**:
- Props: `{ costs: SubSectorDeepDiveData['costsBreakdown'] }`
- Wrapped in `bg-surface-raised border border-surface-overlay rounded p-md`.
- Heading: "COGS Breakdown" in `text-xs font-medium text-text-secondary uppercase tracking-wide`.
- Render a simple horizontal stacked bar visualization using pure CSS/Tailwind (NOT Recharts -- simpler for a single stacked bar):
  - Container: `flex h-8 rounded overflow-hidden`
  - Each segment: `flex items-center justify-center text-xs font-medium` with width set as `style={{ width: '${cost.sharePct}%' }}`
  - Colors: use chart color variables (chart-1 through chart-5) cycling. Apply via `style={{ backgroundColor: 'var(--color-chart-N)' }}`
  - Below the bar, render a compact legend: each item with colored dot + cost item name + share percentage
- Alternative: if the CSS bar is too simple, use Recharts BarChart with layout="vertical" and stacked=true.

**CostBreakdownTable.tsx**:
- Props: `{ costs: SubSectorDeepDiveData['costsBreakdown'] }`
- Wrapped in `bg-surface-raised border border-surface-overlay rounded p-md`.
- Heading: "Cost Structure Details"
- CSS Grid table with columns: Cost Item | Share % | Trend | Notes
- Each row:
  - Cost item name in `text-xs text-text-primary font-medium`
  - Share percentage formatted with `formatPercent(cost.sharePct / 100)` (convert to decimal for formatter)
  - `TrendIndicator` with `direction={cost.trendVsPrior}`
  - Notes in `text-xs text-text-secondary` (may be long -- allow wrapping)
- Grid template: `grid-cols-[1fr_80px_60px_2fr]` or similar to give notes column more space.

**MarginLevers.tsx**:
- Props: `{ levers: SubSectorDeepDiveData['marginLevers'] }`
- Wrapped in `bg-surface-raised border border-surface-overlay rounded p-md`.
- Heading: "Margin Levers"
- Sort levers by `impactBps` descending (highest impact first).
- Render each lever as a card/row:
  - Lever name in `text-xs text-text-primary font-medium`
  - Impact in basis points: `+${lever.impactBps} bps` in `text-xs font-semibold text-positive`
  - Feasibility: use `ConfidenceBadge` with `level={lever.feasibility}` (reuses high/medium/low mapping)
  - Explanation in `text-xs text-text-secondary`
- Add a visual impact bar: a thin horizontal bar proportional to impactBps relative to max (e.g., `w-[${(impactBps / maxImpact) * 100}%]` -- use inline style for dynamic width).

**TopQuartileAnalysis.tsx**:
- Props: `{ metrics: SubSectorDeepDiveData['topQuartileAnalysis'] }`
- Wrapped in `bg-surface-raised border border-surface-overlay rounded p-md`.
- Heading: "Performance Benchmarks"
- Render each metric as a structured comparison:
  - Metric name as header in `text-xs text-text-primary font-medium`
  - Three values in a compact row:
    - Top Quartile: value + unit in `text-xs font-semibold text-positive`
    - Median: value + unit in `text-xs text-text-secondary`
    - Bottom Quartile: value + unit in `text-xs text-negative`
  - Top performers listed as compact pills below: `text-xs bg-positive/10 text-positive px-1.5 py-0.5 rounded`
- Optional: add a horizontal range visualization showing where top/median/bottom sit on a scale (simple CSS).

**Important constraints:**
- Sub-Sector Deep Dive is sector-wide analysis (cost structure, benchmarks), NOT company-filterable. The company filter from FilterBar should be a no-op (same pattern as Market Pulse).
- The `costsBreakdown` data does NOT have company fields, confirming sector-wide.
- The `topQuartileAnalysis` has `topPerformers: string[]` with display names -- render as-is, do NOT convert to IDs.
- Use `ConfidenceBadge` for feasibility level display (already supports high/medium/low).
- Use `TrendIndicator` for cost trend direction.
  </action>
  <verify>
Run `npx tsc --noEmit` -- zero TypeScript errors. Verify:
1. Sub-sector header shows "Air Conditioning" with "Monthly Deep Dive" subtitle.
2. Cost breakdown shows stacked bar visualization with 5 cost items.
3. Cost table shows all 5 cost items with share %, trend arrows, and detailed notes.
4. Margin levers sorted by impact (highest first) with feasibility badges.
5. Top-quartile analysis shows 3 metrics with top/median/bottom values and performer pills.
  </verify>
  <done>Sub-Sector Deep Dive section displays cost breakdown, margin levers, and top-quartile analysis for the monthly featured sub-sector. Requirements SSDD-01, SSDD-02, SSDD-03, SSDD-04 satisfied.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with zero errors
- Sub-Sector Deep Dive renders with sub-sector header (SSDD-01)
- Cost breakdown visualization and table show COGS structure (SSDD-02)
- Margin levers ranked by impact with feasibility badges (SSDD-03)
- Top-quartile analysis with benchmarks and top performers (SSDD-04)
- Company filter does NOT affect Sub-Sector Deep Dive display (sector-wide)
</verification>

<success_criteria>
Sub-Sector Deep Dive section renders cost structure benchmarks, margin lever analysis, and top-quartile performance comparison for the monthly featured sub-sector. Requirements SSDD-01 through SSDD-04 are complete.
</success_criteria>

<output>
After completion, create `.planning/phases/06-competitive-landscape-and-sub-sector-analysis/06-02-SUMMARY.md`
</output>
