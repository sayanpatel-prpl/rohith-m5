---
phase: 02-report-shell-and-data-layer
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/app/App.tsx
  - src/components/layout/AppShell.tsx
  - src/components/filters/FilterBar.tsx
  - src/components/filters/CompanyPicker.tsx
  - src/components/filters/SelectFilter.tsx
  - src/components/filters/filter-options.ts
  - src/sections/executive/ExecutiveSnapshot.tsx
  - src/sections/financial/FinancialPerformance.tsx
  - src/sections/market-pulse/MarketPulse.tsx
  - src/sections/deals/DealsTransactions.tsx
  - src/sections/operations/OperationalIntelligence.tsx
  - src/sections/leadership/LeadershipGovernance.tsx
  - src/sections/competitive/CompetitiveMoves.tsx
  - src/sections/deep-dive/SubSectorDeepDive.tsx
  - src/sections/action-lens/ActionLens.tsx
  - src/sections/watchlist/Watchlist.tsx
  - src/components/sections/index.ts
autonomous: true

must_haves:
  truths:
    - "Report shell displays sidebar with 10 section names and active section visually indicated with brand accent"
    - "Clicking a section in sidebar lazy-loads only that section's code -- visible as separate chunk in network tab"
    - "FilterBar renders as compact horizontal strip below TopBar, always visible, with 4 filter controls in a single row"
    - "CompanyPicker allows multi-select of companies via Radix Popover + Checkbox pattern"
    - "Selecting filters updates URL query params and visible section data without triggering new API requests"
    - "Browser back/forward restores previous filter state from URL"
    - "Each section placeholder shows section name, data recency, and filtered company/record count proving the full pipeline works"
  artifacts:
    - path: "src/app/App.tsx"
      provides: "Updated root with QueryClientProvider, ReactQueryDevtools, and lazy-loaded section routes"
      contains: "QueryClientProvider"
    - path: "src/components/layout/AppShell.tsx"
      provides: "Updated layout with FilterBar between TopBar and content area, useFilterUrlSync activation"
      contains: "FilterBar"
    - path: "src/components/filters/FilterBar.tsx"
      provides: "Horizontal filter strip with CompanyPicker and 3 SelectFilter dropdowns"
      exports: ["FilterBar"]
    - path: "src/components/filters/CompanyPicker.tsx"
      provides: "Multi-select company dropdown using Radix Popover + Checkbox"
      exports: ["CompanyPicker"]
    - path: "src/components/filters/SelectFilter.tsx"
      provides: "Reusable single-select filter using Radix Select"
      exports: ["SelectFilter"]
    - path: "src/components/sections/index.ts"
      provides: "lazySections map: Record<SectionId, React.LazyExoticComponent>"
      exports: ["lazySections"]
    - path: "src/sections/executive/ExecutiveSnapshot.tsx"
      provides: "Placeholder section proving fetch->cache->filter pipeline"
      contains: "export default"
    - path: "src/sections/financial/FinancialPerformance.tsx"
      provides: "Placeholder section proving fetch->cache->filter pipeline"
      contains: "export default"
  key_links:
    - from: "src/app/App.tsx"
      to: "src/components/sections/index.ts"
      via: "lazySections map used in route rendering"
      pattern: "lazySections"
    - from: "src/app/App.tsx"
      to: "src/api/query-client.ts"
      via: "QueryClientProvider wrapping entire app"
      pattern: "QueryClientProvider.*client.*queryClient"
    - from: "src/components/layout/AppShell.tsx"
      to: "src/stores/url-sync.ts"
      via: "useFilterUrlSync() call activating bidirectional sync"
      pattern: "useFilterUrlSync"
    - from: "src/components/layout/AppShell.tsx"
      to: "src/components/filters/FilterBar.tsx"
      via: "FilterBar rendered between TopBar and content"
      pattern: "<FilterBar"
    - from: "src/components/filters/FilterBar.tsx"
      to: "src/stores/filter-store.ts"
      via: "useFilterStore selectors for current state and setters"
      pattern: "useFilterStore"
    - from: "src/components/filters/CompanyPicker.tsx"
      to: "src/stores/filter-store.ts"
      via: "useFilterStore for companies state and setCompanies action"
      pattern: "useFilterStore"
    - from: "src/sections/*/index.tsx"
      to: "src/hooks/use-filtered-data.ts"
      via: "useFilteredData hook to get cached + filtered section data"
      pattern: "useFilteredData"
    - from: "src/components/sections/index.ts"
      to: "src/sections/*/*.tsx"
      via: "React.lazy dynamic imports"
      pattern: "lazy\\(\\(\\) => import"
---

<objective>
Wire the report shell UI: update App.tsx with QueryClientProvider and lazy-loaded routes, add FilterBar to AppShell layout, build filter UI components (CompanyPicker multi-select, SelectFilter single-select), create 10 placeholder section components that prove the full data pipeline (fetch -> cache -> filter -> render), and connect everything via the stores and hooks from Plan 02-01.

Purpose: This completes the report infrastructure so that content modules (Phases 3-9) simply need to replace placeholder section bodies with real UI -- the data fetching, caching, filtering, lazy loading, and URL sync are all operational.

Output: Working report shell where clicking sidebar sections lazy-loads placeholder components that display filtered mock data, filter controls update URL and data simultaneously, and navigation is cached.
</objective>

<execution_context>
@/Users/prateekkurkanji/.claude/get-shit-done/workflows/execute-plan.md
@/Users/prateekkurkanji/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-report-shell-and-data-layer/02-RESEARCH.md
@.planning/phases/02-report-shell-and-data-layer/02-CONTEXT.md
@.planning/phases/02-report-shell-and-data-layer/02-01-SUMMARY.md
@src/app/App.tsx
@src/app/routes.tsx
@src/components/layout/AppShell.tsx
@src/components/layout/TopBar.tsx
@src/components/layout/Sidebar.tsx
@src/components/layout/SectionWrapper.tsx
@src/components/ui/SectionSkeleton.tsx
@src/components/brand/BrandProvider.tsx
@src/types/sections.ts
@src/types/common.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: FilterBar UI components (CompanyPicker, SelectFilter, FilterBar)</name>
  <files>
    src/components/filters/filter-options.ts
    src/components/filters/SelectFilter.tsx
    src/components/filters/CompanyPicker.tsx
    src/components/filters/FilterBar.tsx
  </files>
  <action>
    1. Create `src/components/filters/filter-options.ts`:
       - Import `COMPANIES`, `SUB_SECTORS` from `../../data/mock/companies`
       - Export `COMPANY_OPTIONS` as `Array<{ id: string; name: string }>` derived from COMPANIES
       - Export `SUB_CATEGORY_OPTIONS` as `Array<{ value: string; label: string }>` with 'all' as first option plus each sub-sector
       - Export `PERFORMANCE_OPTIONS` as `Array<{ value: string; label: string }>`: all, outperform, inline, underperform
       - Export `TIME_PERIOD_OPTIONS` as `Array<{ value: string; label: string }>`: QoQ, YoY, MoM

    2. Create `src/components/filters/SelectFilter.tsx`:
       - Reusable single-select dropdown using Radix Select (`import { Select } from 'radix-ui'`)
       - Props: `label: string`, `value: string`, `options: Array<{ value: string; label: string }>`, `onChange: (value: string) => void`
       - Compact styling matching Bloomberg terminal aesthetic: text-xs, bg-surface-raised, border-surface-overlay
       - Trigger shows current value label, content renders scrollable option list
       - Use `Select.Root`, `Select.Trigger`, `Select.Portal`, `Select.Content`, `Select.Viewport`, `Select.Item`, `Select.ItemText`
       - Add `Select.Value` inside Trigger to show selected value
       - Width: auto, min-w-24 -- compact but readable

    3. Create `src/components/filters/CompanyPicker.tsx`:
       - Multi-select company dropdown using Radix Popover + Checkbox (per RESEARCH.md -- Radix Select does not support multi-select)
       - Import `Popover`, `Checkbox` from `radix-ui`
       - Props: `options: Array<{ id: string; name: string }>` (company list)
       - Read `companies` and `setCompanies` from `useFilterStore` via individual selectors
       - Trigger button label:
         - Empty selection: "All Companies" (shows no filter active)
         - 1-3 companies: show their names comma-separated
         - 4+ companies: "{N} companies"
       - Content: scrollable list (`max-h-60 overflow-y-auto`) of Checkbox + label rows
       - Each checkbox toggles company ID in/out of the companies array
       - Add a "Clear all" button at bottom when any companies are selected
       - Compact styling: text-xs, py-xs, consistent with SelectFilter aesthetic
       - Trigger shows ChevronDown indicator (use unicode U+25BE small down triangle)

    4. Create `src/components/filters/FilterBar.tsx`:
       - Horizontal strip that renders below TopBar, full width of content area
       - Always visible (not collapsible) per user decision
       - Compact single row layout: `flex items-center gap-md px-md h-9 bg-surface border-b border-surface-overlay`
       - Left side: "Filters" label in text-xs text-text-muted
       - Then 4 filter controls in a row:
         1. `<CompanyPicker options={COMPANY_OPTIONS} />` -- multi-select
         2. `<SelectFilter label="Sub-category" value={subCategory} options={SUB_CATEGORY_OPTIONS} onChange={setSubCategory} />`
         3. `<SelectFilter label="Performance" value={performanceTier} options={PERFORMANCE_OPTIONS} onChange={setPerformanceTier} />`
         4. `<SelectFilter label="Period" value={timePeriod} options={TIME_PERIOD_OPTIONS} onChange={setTimePeriod} />`
       - Right side: "Reset" button (text-xs, only visible when filters differ from defaults) that calls `resetFilters`
       - Read filter state and actions from `useFilterStore` using individual primitive selectors
       - Import filter option constants from `./filter-options`
  </action>
  <verify>
    - `npx tsc --noEmit` passes with zero errors
    - FilterBar imports resolve correctly (filter-options, CompanyPicker, SelectFilter, useFilterStore)
    - Radix UI imports work from the unified `radix-ui` package
  </verify>
  <done>
    - FilterBar renders as compact horizontal strip with 4 filter controls
    - CompanyPicker uses Radix Popover + Checkbox for multi-select
    - SelectFilter uses Radix Select for single-select dropdowns
    - Filter options derived from mock data (companies, sub-sectors)
    - All filter controls read from and write to Zustand filter store
    - Reset button appears when filters differ from defaults
    - All files compile with zero TypeScript errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Lazy-loaded section placeholders, updated App.tsx, and updated AppShell</name>
  <files>
    src/sections/executive/ExecutiveSnapshot.tsx
    src/sections/financial/FinancialPerformance.tsx
    src/sections/market-pulse/MarketPulse.tsx
    src/sections/deals/DealsTransactions.tsx
    src/sections/operations/OperationalIntelligence.tsx
    src/sections/leadership/LeadershipGovernance.tsx
    src/sections/competitive/CompetitiveMoves.tsx
    src/sections/deep-dive/SubSectorDeepDive.tsx
    src/sections/action-lens/ActionLens.tsx
    src/sections/watchlist/Watchlist.tsx
    src/components/sections/index.ts
    src/app/App.tsx
    src/components/layout/AppShell.tsx
  </files>
  <action>
    1. Create 10 placeholder section components in `src/sections/{name}/{ComponentName}.tsx`:
       - Each MUST use `export default function ComponentName()` (React.lazy requires default export per RESEARCH.md pitfall 3)
       - Each calls `useFilteredData('{sectionId}')` to get filtered, cached data
       - Each renders a minimal but informative placeholder:
         ```
         Section Name
         Data as of: {dataAsOf}
         {recordCount} records | {filteredCount} after filters
         Active filters: {summary of non-default filters}
         ```
       - Use `DataRecencyTag` from `src/components/ui/DataRecencyTag` for the data-as-of display
       - The record count proves data was fetched, and filtered count proves client-side filtering works
       - Show a brief note: "Full module will be built in Phase N"
       - Handle loading state: show `<SectionSkeleton variant="mixed" />` when `isPending`
       - Handle error state: throw error to let SectionWrapper's ErrorBoundary catch it
       - Each section should count records differently based on its data shape:
         - executive: `bullets.length` bullets, `redFlags.length` red flags
         - financial: `companies.length` companies
         - market-pulse: `demandSignals.length` signals, `inputCosts.length` costs
         - deals: `deals.length` deals
         - operations: total of all 4 array lengths
         - leadership: total of cxoChanges + boardReshuffles + promoterStakeChanges + auditorFlags
         - competitive: total of all 5 array lengths
         - deep-dive: `costsBreakdown.length` items
         - action-lens: `takeaways.length` takeaways
         - watchlist: total of all 4 signal arrays
       - Style with Tailwind: p-md, text-xs for details, text-sm font-semibold for section name, text-text-muted for metadata

    2. Create `src/components/sections/index.ts`:
       - Import `lazy` from `react`
       - Import `SectionId` from `../../types/common`
       - Export `lazySections` as `Record<SectionId, React.LazyExoticComponent<React.ComponentType>>`:
         ```
         'executive':    lazy(() => import('../../sections/executive/ExecutiveSnapshot')),
         'market-pulse': lazy(() => import('../../sections/market-pulse/MarketPulse')),
         'financial':    lazy(() => import('../../sections/financial/FinancialPerformance')),
         'deals':        lazy(() => import('../../sections/deals/DealsTransactions')),
         'operations':   lazy(() => import('../../sections/operations/OperationalIntelligence')),
         'leadership':   lazy(() => import('../../sections/leadership/LeadershipGovernance')),
         'competitive':  lazy(() => import('../../sections/competitive/CompetitiveMoves')),
         'deep-dive':    lazy(() => import('../../sections/deep-dive/SubSectorDeepDive')),
         'action-lens':  lazy(() => import('../../sections/action-lens/ActionLens')),
         'watchlist':    lazy(() => import('../../sections/watchlist/Watchlist')),
         ```

    3. Update `src/app/App.tsx`:
       - REMOVE the inline `PlaceholderContent` component (replaced by lazy-loaded sections)
       - ADD imports: `Suspense` from 'react', `QueryClientProvider` from '@tanstack/react-query', `ReactQueryDevtools` from '@tanstack/react-query-devtools', `queryClient` from '../api/query-client', `lazySections` from '../components/sections', `SectionSkeleton` from '../components/ui/SectionSkeleton'
       - Wrap entire app in `<QueryClientProvider client={queryClient}>` -- MUST be at root level, above BrowserRouter, to avoid "No QueryClient set" errors on navigation (per RESEARCH.md pitfall 5)
       - Add `<ReactQueryDevtools initialIsOpen={false} />` as last child inside QueryClientProvider (dev-only query inspector)
       - Update section route rendering: instead of `<PlaceholderContent label={section.label} />`, render:
         ```tsx
         const LazySection = lazySections[section.path as SectionId];
         <SectionWrapper sectionKey={section.path}>
           <Suspense fallback={<SectionSkeleton variant="mixed" />}>
             <LazySection />
           </Suspense>
         </SectionWrapper>
         ```
       - Keep existing route structure: `/:tenantSlug/report` with BrandProvider + AppShell, index redirects to 'executive', catch-all redirects
       - Import `SectionId` type from '../types/common' for the cast

    4. Update `src/components/layout/AppShell.tsx`:
       - ADD imports: `FilterBar` from '../filters/FilterBar', `useFilterUrlSync` from '../../stores/url-sync'
       - Call `useFilterUrlSync()` at the top of the component -- this activates bidirectional URL <-> store sync for the entire report shell
       - Insert `<FilterBar />` between `<TopBar />` and the flex container with Sidebar + main
       - Keep all existing layout structure (TopBar, Sidebar, main with Outlet)
       - The updated layout order should be:
         ```
         <div flex-col h-screen>
           <TopBar />
           <FilterBar />
           <div flex flex-1 min-h-0>
             <Sidebar />
             <main>{Outlet}</main>
           </div>
         </div>
         ```
  </action>
  <verify>
    - `npx tsc --noEmit` passes with zero errors
    - `npm run build` succeeds -- Vite bundles with code splitting (look for multiple chunk files in output)
    - Verify the build output shows separate chunks: each lazy-loaded section should be its own .js chunk
    - `npm run dev` starts and navigating to `/pricio/report/executive` shows the placeholder with data counts
    - Navigating between sections shows SectionSkeleton briefly then loads placeholder (proves lazy loading)
    - Opening Network tab in browser DevTools shows new chunk files loading only when first visiting each section
    - FilterBar appears between TopBar and content area with 4 filter controls
    - Changing a filter updates the URL query params (visible in address bar)
    - Using browser Back button restores previous filter state
    - Existing tests still pass: `npm test`
  </verify>
  <done>
    - 10 placeholder section components exist in src/sections/*/. Each uses useFilteredData and shows filtered data counts
    - lazySections map provides React.lazy imports for all 10 sections
    - App.tsx wraps everything in QueryClientProvider with ReactQueryDevtools
    - App.tsx routes use Suspense + SectionSkeleton fallback with lazy-loaded section components
    - AppShell.tsx activates useFilterUrlSync and renders FilterBar between TopBar and content
    - Clicking sidebar sections lazy-loads only that section's chunk (visible in network tab)
    - Filter changes update URL params and visible data without new API requests
    - Browser back/forward restores filter state
    - Repeat navigation to a section does not re-fetch (TanStack Query cache hit)
    - Build produces separate chunks per section (code splitting verified)
    - TypeScript compiles and all existing tests pass
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- zero TypeScript errors across all new and modified files
2. `npm test` -- existing formatter tests still pass
3. `npm run build` -- succeeds, output shows multiple chunk files (one per lazy section)
4. `npm run dev` and navigate to `/pricio/report`:
   a. Sidebar shows 10 sections with active state on Executive Snapshot
   b. FilterBar visible below TopBar with Company picker, Sub-category, Performance, Period controls
   c. Executive Snapshot placeholder shows data counts (e.g., "5 bullets | 4 red flags")
   d. Click "Financial Performance" in sidebar -- network tab shows new chunk loading, placeholder shows "16 companies"
   e. Click back to "Executive Snapshot" -- no network request (cached)
   f. Select "Voltas" + "Blue Star" in CompanyPicker -- URL updates to `?companies=voltas,bluestar`
   g. Financial Performance placeholder now shows "2 companies" (filtered)
   h. Copy URL, open in new tab -- same filtered state loads
   i. Click browser Back -- previous filter state restores
   j. Click "Reset" in FilterBar -- all filters clear, URL params removed
5. Switch tenant: navigate to `/bcg/report` -- branding changes, filters and sections still work
</verification>

<success_criteria>
- Report shell displays sidebar with 10 section names, active section indicated (FOUND-10)
- Clicking a section lazy-loads only that section's code, visible in network tab (FOUND-11)
- FilterBar shows compact horizontal strip with multi-select companies, sub-category, performance tier, time period (FOUND-13)
- Filter changes update visible data without API refetch (FOUND-14)
- Filters sync to URL query params -- shareable, bookmarkable, browser back works (user decision)
- API client with TanStack Query caching -- repeat navigation doesn't re-fetch (FOUND-09)
- All 6 requirements (FOUND-09 through FOUND-14) are satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/02-report-shell-and-data-layer/02-02-SUMMARY.md`
</output>
