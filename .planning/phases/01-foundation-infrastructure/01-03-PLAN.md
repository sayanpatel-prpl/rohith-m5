---
phase: 01-foundation-infrastructure
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - dashboard_build_v2/src/components/source/SourceAttribution.tsx
  - dashboard_build_v2/src/components/source/TierBadge.tsx
  - dashboard_build_v2/src/components/source/AMServiceLineTag.tsx
  - dashboard_build_v2/src/components/source/index.ts
  - dashboard_build_v2/src/components/ui/Badge.tsx
  - dashboard_build_v2/src/components/ui/StatCard.tsx
  - dashboard_build_v2/src/components/ui/SectionSkeleton.tsx
  - dashboard_build_v2/src/components/ui/DataValue.tsx
  - dashboard_build_v2/src/components/ui/index.ts
  - dashboard_build_v2/src/components/errors/SectionErrorFallback.tsx
  - dashboard_build_v2/src/components/charts/echarts-core.ts
  - dashboard_build_v2/src/components/charts/BaseChart.tsx
  - dashboard_build_v2/src/components/tables/DataTable.tsx
autonomous: true

must_haves:
  truths:
    - "SourceAttribution component renders source name, confidence level, last updated date, and tier badge"
    - "TierBadge renders T1 solid green, T2 solid blue, T3 outline amber, T4 outline red with warning icon"
    - "AMServiceLineTag renders service line labels with appropriate styling"
    - "ECharts core module tree-shakes to include only Bar, Line, Pie, Heatmap, Treemap charts"
    - "DataTable wraps TanStack Table with sorting and filtering"
    - "DataValue displays formatted data or '-' with tooltip for unavailable data"
    - "SectionErrorFallback provides error boundary UI for failed sections"
  artifacts:
    - path: "dashboard_build_v2/src/components/source/SourceAttribution.tsx"
      provides: "Reusable source attribution display"
      exports: ["SourceAttribution"]
    - path: "dashboard_build_v2/src/components/source/TierBadge.tsx"
      provides: "Tier badge with 4-tier styling"
      exports: ["TierBadge"]
    - path: "dashboard_build_v2/src/components/charts/echarts-core.ts"
      provides: "Tree-shaken ECharts instance"
      exports: ["default"]
    - path: "dashboard_build_v2/src/components/tables/DataTable.tsx"
      provides: "TanStack Table wrapper"
      exports: ["DataTable"]
    - path: "dashboard_build_v2/src/components/ui/DataValue.tsx"
      provides: "Graceful data display with fallback"
      exports: ["DataValue"]
  key_links:
    - from: "dashboard_build_v2/src/components/source/SourceAttribution.tsx"
      to: "dashboard_build_v2/src/types/source.ts"
      via: "SourceInfo type import"
      pattern: "import.*SourceInfo.*source"
    - from: "dashboard_build_v2/src/components/charts/echarts-core.ts"
      to: "echarts/core"
      via: "Tree-shaken import"
      pattern: "import.*echarts/core"
    - from: "dashboard_build_v2/src/components/ui/DataValue.tsx"
      to: "dashboard_build_v2/src/lib/formatters.ts"
      via: "safeDisplay function"
      pattern: "import.*safeDisplay"
---

<objective>
Build all shared UI components: source attribution system, A&M service line tags, chart and table wrappers, and common UI primitives.

Purpose: These are cross-cutting components used by every section. Source attribution (SRCA-01 through SRCA-04) is required on every card, chart, and table. ECharts and TanStack Table wrappers ensure consistent chart/table patterns. DataValue ensures graceful degradation.
Output: Complete component library ready for section development in Phase 2+.
</objective>

<execution_context>
@C:/Users/rohit/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rohit/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-infrastructure/01-RESEARCH.md
@.planning/phases/01-foundation-infrastructure/01-01-SUMMARY.md

# V1 reference for component patterns
@src/components/ui/SectionSkeleton.tsx
@src/components/layout/SectionWrapper.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create source attribution and A&M service line components</name>
  <files>
    dashboard_build_v2/src/components/source/SourceAttribution.tsx
    dashboard_build_v2/src/components/source/TierBadge.tsx
    dashboard_build_v2/src/components/source/AMServiceLineTag.tsx
    dashboard_build_v2/src/components/source/index.ts
  </files>
  <action>
    **TierBadge.tsx (SRCA-02):** Create a badge component that renders tier indicators with 4 distinct styles:
    - T1: Solid green background, white text. Label "T1". Use Tailwind: `bg-tier-1 text-white px-1.5 py-0.5 rounded text-[10px] font-semibold`
    - T2: Solid blue background, white text. Label "T2". Use `bg-tier-2 text-white ...`
    - T3: Outline amber border, amber text. Label "T3". Use `border border-tier-3 text-tier-3 ...`
    - T4: Outline red border, red text + warning icon (unicode triangle ⚠). Label "T4". Use `border border-tier-4 text-tier-4 ...`
    Props: `{ tier: SourceTier; size?: 'sm' | 'md' }`. Import SourceTier from types/source.
    Use clsx for conditional classes. Tier styles should reference the CSS custom properties defined in tokens.css (--color-tier-1, etc.) via Tailwind's `bg-tier-1` etc. If Tailwind v4 doesn't auto-generate these utilities from @theme, use inline style with var(--color-tier-X) as fallback.

    **SourceAttribution.tsx (SRCA-01, SRCA-03):** Create the reusable source attribution component.
    Props: `{ source: SourceInfo; compact?: boolean; className?: string }`.
    - Full mode (compact=false): Flex row with TierBadge, source name, confidence badge, last updated date. Wrapped in a subtle container with muted text.
    - Compact mode (compact=true): Inline flex with smaller text (text-[10px]), just TierBadge + source name.
    - If source.url exists, make source name a link (opens in new tab).
    - Confidence badges: "verified" gets a checkmark icon, "derived" gets a calculation icon, "estimated" gets a tilde icon. Use unicode: verified=✓, derived=≈, estimated=~.
    - Import SourceInfo from types/source, TierBadge from ./TierBadge, clsx.

    **AMServiceLineTag.tsx (AMTH-02):** Create a tag component for A&M service line labels.
    Props: `{ serviceLine: AMServiceLine; size?: 'sm' | 'md'; className?: string }`.
    Renders as a pill/badge with the service line label. Color-coded by service line category:
    - CPI, Operations: Use am-improvement color
    - Restructuring: Use am-turnaround color
    - Transaction Advisory, PE Services: Use am-transaction color
    - Digital: Use am-neutral color
    Use text-xs font-medium. Background is a 10% opacity tint of the category color, text is the full color. Import AMServiceLine from types/am-theme, clsx.

    **index.ts:** Barrel export all three components.
  </action>
  <verify>
    Run `cd dashboard_build_v2 && npx tsc --noEmit` — all source/ component files type-check.
    Verify TierBadge renders 4 distinct styles (check the TIER_STYLES constant or class mapping covers all 4 tiers).
    Verify SourceAttribution imports SourceInfo type correctly.
    Verify AMServiceLineTag covers all 6 service lines.
  </verify>
  <done>
    SourceAttribution renders with TierBadge, confidence indicator, and source name — ready to be placed on every card/chart/table (SRCA-03). TierBadge has 4-tier styling per SRCA-02. AMServiceLineTag renders A&M service line labels per AMTH-02.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create chart wrapper, table wrapper, and UI primitives</name>
  <files>
    dashboard_build_v2/src/components/charts/echarts-core.ts
    dashboard_build_v2/src/components/charts/BaseChart.tsx
    dashboard_build_v2/src/components/tables/DataTable.tsx
    dashboard_build_v2/src/components/ui/Badge.tsx
    dashboard_build_v2/src/components/ui/StatCard.tsx
    dashboard_build_v2/src/components/ui/SectionSkeleton.tsx
    dashboard_build_v2/src/components/ui/DataValue.tsx
    dashboard_build_v2/src/components/ui/index.ts
    dashboard_build_v2/src/components/errors/SectionErrorFallback.tsx
  </files>
  <action>
    **echarts-core.ts:** Tree-shaken ECharts setup. MUST NOT import all of echarts. Import from echarts/core:
    ```
    import * as echarts from 'echarts/core';
    import { BarChart, LineChart, PieChart, HeatmapChart, TreemapChart, ScatterChart } from 'echarts/charts';
    import { TitleComponent, TooltipComponent, GridComponent, LegendComponent, DataZoomComponent, ToolboxComponent, VisualMapComponent } from 'echarts/components';
    import { CanvasRenderer } from 'echarts/renderers';
    import { LabelLayout, UniversalTransition } from 'echarts/features';
    ```
    Register all with echarts.use([...]). Export default echarts.
    This is Pitfall 3 from research — without tree-shaking, bundle adds ~1MB.

    **BaseChart.tsx:** Wrapper around echarts-for-react using the tree-shaken echarts instance.
    Props: `{ option: EChartsOption; height?: string | number; loading?: boolean; theme?: 'light' | 'dark'; className?: string; source?: SourceInfo }`.
    Import ReactEChartsCore from echarts-for-react/core (NOT echarts-for-react directly — this allows using custom echarts instance). Import echarts from ./echarts-core.
    Render ReactEChartsCore with the echarts instance and option. Apply className and height. If source prop provided, render SourceAttribution below the chart (SRCA-03).
    Handle theme by passing appropriate echarts theme or using CSS variables for chart colors.
    Set `opts={{ renderer: 'canvas' }}` and `notMerge={true}` for clean option updates.

    **DataTable.tsx:** Generic TanStack Table wrapper for financial data.
    Generic props: `<T>{ data: T[]; columns: ColumnDef<T, any>[]; sorting?: boolean; filtering?: boolean; className?: string; source?: SourceInfo; emptyMessage?: string }`.
    Uses useReactTable with getCoreRowModel, getSortedRowModel (if sorting=true), getFilteredRowModel (if filtering=true).
    Renders semantic HTML table with Tailwind classes matching the dashboard's design:
    - thead: text-xs font-semibold text-text-muted uppercase tracking-wider, border-b-2
    - th with sort: cursor-pointer, hover:text-text-primary, active column gets brand-accent color, sort arrow indicator
    - tbody td: text-sm, py-2.5 px-3, border-b border-surface-overlay
    - tr hover: bg-surface-raised
    If source provided, render SourceAttribution below table.
    Export DataTable component.

    **Badge.tsx:** Simple pill badge component.
    Props: `{ children: ReactNode; variant: 'success' | 'warning' | 'danger' | 'info' | 'neutral'; size?: 'sm' | 'md' }`.
    Maps variants to Tailwind classes using semantic colors from tokens.

    **StatCard.tsx:** Card displaying a single metric with optional trend.
    Props: `{ label: string; value: string; trend?: { value: number; direction: 'up' | 'down' | 'flat' }; source?: SourceInfo; className?: string }`.
    Renders a card with surface-raised background, label in text-muted, value in text-2xl font-semibold, optional trend arrow with positive/negative color. If source provided, SourceAttribution in compact mode at bottom.

    **DataValue.tsx (DATA-04):** Graceful data display component.
    Props: `{ value: number | null | undefined; formatter: (v: number) => string; tooltip?: string; className?: string }`.
    Uses safeDisplay() from lib/formatters.ts. If hasData is false, renders "-" with a title attribute tooltip. If hasData is true, renders the formatted value. This is the primary way sections display data — ensures no broken layouts when data is unavailable.

    **SectionSkeleton.tsx:** Loading skeleton for lazy-loaded sections. Port from v1 or create: renders animated pulse placeholder blocks mimicking a section layout. Props: `{ variant?: 'table' | 'chart' | 'mixed' | 'cards' }`.

    **SectionErrorFallback.tsx:** Error boundary fallback component. Props match react-error-boundary's FallbackProps: `{ error: Error; resetErrorBoundary: () => void }`. Renders error message with retry button in a centered layout.

    **ui/index.ts:** Barrel export Badge, StatCard, SectionSkeleton, DataValue.
  </action>
  <verify>
    Run `cd dashboard_build_v2 && npx tsc --noEmit` — all component files type-check.
    Verify echarts-core.ts imports from echarts/core (NOT echarts main entry).
    Verify BaseChart.tsx uses ReactEChartsCore from echarts-for-react/core.
    Verify DataValue.tsx imports safeDisplay from lib/formatters.ts.
    Verify DataTable.tsx uses @tanstack/react-table imports correctly.
  </verify>
  <done>
    ECharts core is tree-shaken with only needed chart types registered. BaseChart wraps echarts-for-react with source attribution. DataTable wraps TanStack Table with sorting/filtering. DataValue ensures graceful "-" display for missing data. All UI primitives ready for section development.
  </done>
</task>

</tasks>

<verification>
1. SourceAttribution renders source name, confidence, lastUpdated, and TierBadge
2. TierBadge shows 4 distinct styles: T1 solid green, T2 solid blue, T3 outline amber, T4 outline red with warning
3. AMServiceLineTag covers all 6 A&M service lines
4. echarts-core.ts imports ONLY from echarts/core, echarts/charts, echarts/components, echarts/renderers
5. DataTable renders sortable headers with sort indicators
6. DataValue shows "-" with tooltip for null/undefined values
7. SectionErrorFallback provides reset/retry capability
8. `npx tsc --noEmit` passes for all files
</verification>

<success_criteria>
- Source attribution system complete: SourceAttribution + TierBadge + AMServiceLineTag
- TierBadge styling matches spec: T1 green, T2 blue, T3 amber outline, T4 red outline + warning
- ECharts tree-shaken to ~300KB instead of ~1MB
- DataTable provides sortable/filterable financial tables
- DataValue handles graceful degradation for all null/undefined values
- All components are reusable and accept source prop for attribution
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-infrastructure/01-03-SUMMARY.md`
</output>
