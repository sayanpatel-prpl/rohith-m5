---
phase: 01-foundation-and-architecture
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/types/common.ts
  - src/types/financial.ts
  - src/types/company.ts
  - src/types/sections.ts
  - src/lib/formatters.ts
  - src/lib/formatters.test.ts
  - src/components/ui/StatCard.tsx
  - src/components/ui/TrendIndicator.tsx
  - src/components/ui/PerformanceTag.tsx
  - src/components/ui/SectionSkeleton.tsx
  - src/components/ui/EditionBadge.tsx
  - src/components/ui/DataRecencyTag.tsx
  - src/components/charts/TrendLineChart.tsx
  - src/components/charts/BarComparisonChart.tsx
  - src/components/charts/ChartAnnotation.tsx
  - src/components/charts/ChartTooltip.tsx
  - vitest.config.ts
autonomous: true

must_haves:
  truths:
    - "StatCard displays a metric label, formatted INR value, and trend direction with brand colors"
    - "TrendIndicator shows directional arrow (up/down/flat) with semantic colors (green/red/neutral)"
    - "PerformanceTag renders outperform/inline/underperform badges with color + icon + label"
    - "SectionSkeleton displays content-shaped shimmer placeholders in table, chart, cards, and mixed variants"
    - "TrendLineChart renders line chart using CSS custom property colors (var(--color-chart-N)) that change when tenant switches"
    - "BarComparisonChart renders bar chart using CSS custom property colors that change when tenant switches"
    - "formatINRCr(1500) returns 'INR 1,500 Cr' and formatPercent(12.5) returns '+12.5%'"
    - "All 10 section data type interfaces are defined with discriminated union on 'section' field"
    - "EditionBadge shows 'February 2026 Edition' and DataRecencyTag shows 'Data as of Q3 FY25'"
    - "TrendLineChart renders ReferenceDot annotations from annotations array using createAnnotation helper"
  artifacts:
    - path: "src/types/sections.ts"
      provides: "Discriminated union SectionData type covering all 10 section payloads"
      exports: ["SectionData", "ExecutiveSnapshotData", "FinancialPerformanceData", "MarketPulseData", "DealsTransactionsData", "OperationalIntelligenceData", "LeadershipGovernanceData", "CompetitiveMovesData", "SubSectorDeepDiveData", "ActionLensData", "WatchlistData"]
    - path: "src/lib/formatters.ts"
      provides: "INR Cr/Lakh, percentage, basis points, growth rate formatters"
      exports: ["formatINRCr", "formatINRLakh", "formatINRAuto", "formatPercent", "formatBps", "formatGrowthRate", "formatIndianNumber"]
    - path: "src/lib/formatters.test.ts"
      provides: "Unit tests for all formatter functions"
      min_lines: 40
    - path: "src/components/ui/StatCard.tsx"
      provides: "Metric display card with label, formatted value, and trend"
      exports: ["StatCard"]
    - path: "src/components/ui/TrendIndicator.tsx"
      provides: "Directional trend arrow with semantic coloring"
      exports: ["TrendIndicator"]
    - path: "src/components/ui/PerformanceTag.tsx"
      provides: "Performance level badge (outperform/inline/underperform)"
      exports: ["PerformanceTag"]
    - path: "src/components/ui/SectionSkeleton.tsx"
      provides: "Shimmer loading placeholders in 4 variants"
      exports: ["SectionSkeleton"]
    - path: "src/components/charts/TrendLineChart.tsx"
      provides: "Recharts line chart wrapper consuming brand CSS variables"
      exports: ["TrendLineChart"]
    - path: "src/components/charts/BarComparisonChart.tsx"
      provides: "Recharts bar chart wrapper consuming brand CSS variables"
      exports: ["BarComparisonChart"]
  key_links:
    - from: "src/components/ui/StatCard.tsx"
      to: "src/lib/formatters.ts"
      via: "Uses formatINRAuto/formatPercent to display formatted values"
      pattern: "formatINR|formatPercent"
    - from: "src/components/ui/StatCard.tsx"
      to: "src/components/ui/TrendIndicator.tsx"
      via: "Renders TrendIndicator alongside the metric value"
      pattern: "TrendIndicator"
    - from: "src/components/charts/TrendLineChart.tsx"
      to: "src/theme/tokens.css"
      via: "References var(--color-chart-N) for stroke/fill colors"
      pattern: "var\\(--color-chart"
    - from: "src/components/charts/BarComparisonChart.tsx"
      to: "src/theme/tokens.css"
      via: "References var(--color-chart-N) for fill colors"
      pattern: "var\\(--color-chart"
    - from: "src/types/sections.ts"
      to: "src/types/financial.ts"
      via: "Section data interfaces reference financial metric types"
      pattern: "import.*financial"
    - from: "src/components/charts/TrendLineChart.tsx"
      to: "src/components/charts/ChartTooltip.tsx"
      via: "Custom tooltip component passed to Recharts Tooltip"
      pattern: "ChartTooltip"
    - from: "src/components/charts/TrendLineChart.tsx"
      to: "src/components/charts/ChartAnnotation.tsx"
      via: "Maps over annotations array and renders ReferenceDot using createAnnotation helper"
      pattern: "createAnnotation|ReferenceDot"
---

<objective>
Create all TypeScript data contracts for the 10 report sections, build centralized Indian financial formatters with unit tests, implement shared UI primitives (StatCard, TrendIndicator, PerformanceTag, SectionSkeleton, EditionBadge, DataRecencyTag), and build chart wrappers (TrendLineChart, BarComparisonChart) that consume brand CSS variables for automatic tenant-aware theming.

Purpose: Every content module in Phases 3-9 depends on these types, formatters, primitives, and chart wrappers. Building them now means content modules can focus purely on domain logic and composition.
Output: Type-safe data contracts, tested formatters, and a library of brand-aware UI primitives and chart components ready for consumption.
</objective>

<execution_context>
@/Users/prateekkurkanji/.claude/get-shit-done/workflows/execute-plan.md
@/Users/prateekkurkanji/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-and-architecture/01-RESEARCH.md
@.planning/phases/01-foundation-and-architecture/01-CONTEXT.md
@.planning/phases/01-foundation-and-architecture/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: TypeScript data contracts and Indian financial formatters with tests</name>
  <files>
    src/types/common.ts
    src/types/financial.ts
    src/types/company.ts
    src/types/sections.ts
    src/lib/formatters.ts
    src/lib/formatters.test.ts
    vitest.config.ts
  </files>
  <action>
    1. **Install Vitest for testing:**
       ```
       npm install -D vitest
       ```
       Create `vitest.config.ts` with default config importing from `vite.config.ts`.

    2. **Create `src/types/common.ts`** — Shared types used across sections:
       - `TimeRange`: `"QoQ" | "YoY" | "MoM"`
       - `DataRecency`: `{ dataAsOf: string; lastUpdated: string }` (e.g., dataAsOf: "Q3 FY25", lastUpdated: ISO date)
       - `ConfidenceLevel`: `"high" | "medium" | "low"`
       - `PerformanceLevel`: `"outperform" | "inline" | "underperform"`
       - `TrendDirection`: `"up" | "down" | "flat"`
       - `ChartAnnotation`: `{ key: string; x: string | number; y: number; label: string }`
       - `SectionId`: Literal union of all 10 section path strings: `"executive" | "market-pulse" | "financial" | "deals" | "operations" | "leadership" | "competitive" | "deep-dive" | "action-lens" | "watchlist"`

    3. **Create `src/types/financial.ts`** — Financial metric types:
       - `INRAmount`: `{ valueCr: number; formatted?: string }` (amount in Crore)
       - `PercentageMetric`: `{ value: number; direction: TrendDirection; period: TimeRange }`
       - `BasisPointsMetric`: `{ bps: number; direction: TrendDirection }`
       - `FinancialMetrics`: The standard set per company — `{ revenueGrowthYoY: number; ebitdaMargin: number; workingCapitalDays: number; roce: number; debtEquity: number }`

    4. **Create `src/types/company.ts`** — Company entity types:
       - `Company`: `{ id: string; name: string; ticker: string; subSector: string }`
       - `CompanyMetric`: `{ company: Company; metrics: FinancialMetrics; performance: PerformanceLevel; source: string }`

    5. **Create `src/types/sections.ts`** — ALL 10 section data payload interfaces using discriminated unions on the `section` field:
       - `SectionDataBase`: `{ section: string; dataAsOf: string; lastUpdated: string }`
       - `ExecutiveSnapshotData`: section = "executive-snapshot"; fields: bullets (text, theme, significance), redFlags (company, signal, confidence, explanation)
       - `FinancialPerformanceData`: section = "financial-performance"; fields: companies array with metrics, performance tags, varianceAnalysis, source
       - `MarketPulseData`: section = "market-pulse"; fields: demandSignals, inputCosts (commodity, trend, qoqChange, yoyChange), marginOutlook, channelMix
       - `DealsTransactionsData`: section = "deals-transactions"; fields: deals array (type: "M&A" | "PE/VC" | "IPO" | "distressed", parties, value, rationale, date), aiPatterns
       - `OperationalIntelligenceData`: section = "operational-intelligence"; fields: supplyChainSignals, manufacturingCapacity, procurementShifts, retailFootprint
       - `LeadershipGovernanceData`: section = "leadership-governance"; fields: cxoChanges, boardReshuffles, promoterStakeChanges, auditorFlags, aiRiskFlags
       - `CompetitiveMovesData`: section = "competitive-moves"; fields: productLaunches, pricingActions, d2cInitiatives, qcPartnerships, clusterAnalysis
       - `SubSectorDeepDiveData`: section = "sub-sector-deep-dive"; fields: subSector, costsBreakdown, marginLevers, topQuartileAnalysis
       - `ActionLensData`: section = "action-lens"; fields: persona ("PE/Investors" | "Founders" | "COOs/CFOs" | "Procurement Heads"), takeaways, signalScores
       - `WatchlistData`: section = "watchlist"; fields: fundraiseSignals, marginInflectionCandidates, consolidationTargets, stressIndicators

       Define the discriminated union: `type SectionData = ExecutiveSnapshotData | FinancialPerformanceData | ... | WatchlistData`

       Each interface MUST have complete, realistic field definitions. Do NOT use `any` or `unknown` for data fields. Be specific about array item shapes. Reference types from common.ts and financial.ts where appropriate.

    6. **Create `src/lib/formatters.ts`** — Follow RESEARCH.md Pattern 6:
       - Create `Intl.NumberFormat` instances at MODULE SCOPE (not inside functions — see RESEARCH.md anti-pattern)
       - `formatINRCr(amountInCr: number)`: Returns `"INR 1,500 Cr"` format with Indian grouping
       - `formatINRLakh(amountInLakh: number)`: Returns `"INR 45.2 L"` format
       - `formatINRAuto(amountInCr: number)`: Picks Cr or L based on magnitude (< 1 Cr = show in Lakh)
       - `formatPercent(value: number, decimals?: number)`: Returns `"+12.5%"` or `"-3.2%"` with sign
       - `formatBps(bps: number)`: Returns `"+180 bps"` or `"-50 bps"` with sign
       - `formatGrowthRate(rate: number, period?: "QoQ" | "YoY")`: Returns `"+12.5% YoY"` (rate is decimal: 0.125 = 12.5%)
       - `formatIndianNumber(value: number)`: Returns Indian-grouped number string without currency

    7. **Create `src/lib/formatters.test.ts`** — Unit tests using Vitest:
       - Test `formatINRCr(1500)` === `"INR 1,500 Cr"`
       - Test `formatINRCr(0.5)` === `"INR 0.5 Cr"`
       - Test `formatINRLakh(45.2)` === `"INR 45.2 L"`
       - Test `formatINRAuto(1500)` starts with `"INR"` and contains `"Cr"`
       - Test `formatINRAuto(0.5)` contains `"L"` (auto-converts to Lakh)
       - Test `formatPercent(12.5)` === `"+12.5%"`
       - Test `formatPercent(-3.2)` === `"-3.2%"`
       - Test `formatPercent(0)` contains `"0"` and `"%"`
       - Test `formatBps(180)` === `"+180 bps"`
       - Test `formatBps(-50)` === `"-50 bps"`
       - Test `formatGrowthRate(0.125)` === `"+12.5% YoY"`
       - Test `formatGrowthRate(0.125, "QoQ")` === `"+12.5% QoQ"`
       - Test `formatGrowthRate(-0.032)` starts with `"-"`
       - Test `formatIndianNumber(150000)` has Indian grouping (contains `"1,50,000"`)

    8. **Add test script** to `package.json`: `"test": "vitest run"`, `"test:watch": "vitest"`
  </action>
  <verify>
    Run `npx vitest run` — all formatter tests pass.
    Run `npx tsc --noEmit` — all type files compile cleanly with no errors.
    Verify that `SectionData` is a proper discriminated union by checking that narrowing on `section` field works (this will be validated by TypeScript compilation).
  </verify>
  <done>
    All 10 section data type interfaces defined with realistic field shapes and discriminated union. Financial types (INRAmount, PercentageMetric, etc.) defined. All 7 formatter functions implemented and tested with 14+ unit tests passing. No TypeScript errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Shared UI primitives and chart wrappers consuming brand tokens</name>
  <files>
    src/components/ui/StatCard.tsx
    src/components/ui/TrendIndicator.tsx
    src/components/ui/PerformanceTag.tsx
    src/components/ui/SectionSkeleton.tsx
    src/components/ui/EditionBadge.tsx
    src/components/ui/DataRecencyTag.tsx
    src/components/charts/TrendLineChart.tsx
    src/components/charts/BarComparisonChart.tsx
    src/components/charts/ChartAnnotation.tsx
    src/components/charts/ChartTooltip.tsx
  </files>
  <action>
    1. **Create `src/components/ui/TrendIndicator.tsx`** — Directional arrow with semantic color:
       - Props: `direction: TrendDirection` (from common.ts), `size?: "sm" | "md"`, `showLabel?: boolean`
       - "up" renders triangle-up arrow with `text-positive` color
       - "down" renders triangle-down arrow with `text-negative` color
       - "flat" renders a horizontal dash/diamond with `text-neutral` color
       - Use actual Unicode characters: up = "\u25B2", down = "\u25BC", flat = "\u25C6"
       - Size "sm" uses `text-[10px]`, "md" uses `text-xs`
       - If `showLabel`, append "Up", "Down", or "Flat" text

    2. **Create `src/components/ui/PerformanceTag.tsx`** — Follow RESEARCH.md example exactly:
       - Props: `level: PerformanceLevel`, `compact?: boolean`
       - Outperform: green background/text/border, triangle-up icon, "Outperform" label
       - Inline: neutral gray background/text/border, diamond icon, "Inline" label
       - Underperform: red background/text/border, triangle-down icon, "Underperform" label
       - Color classes use semantic tokens: `bg-positive/10 text-positive border-positive/20`, etc.
       - Compact mode shows only icon, no label text
       - High-density sizing: `text-xs`, `px-sm py-xs` padding

    3. **Create `src/components/ui/StatCard.tsx`** — Metric display card:
       - Props: `label: string`, `value: string` (pre-formatted), `trend?: { direction: TrendDirection; label: string }`, `subtitle?: string`, `className?: string`
       - Layout: Vertical stack — label (text-text-muted, text-xs), value (text-text-primary, text-lg, font-semibold), optional trend indicator + trend label, optional subtitle
       - Background: `bg-surface-raised`, subtle border, compact padding (p-md)
       - Trend uses TrendIndicator component alongside the trend label text
       - High-density styling: minimal padding, compact spacing

    4. **Create `src/components/ui/SectionSkeleton.tsx`** — Follow RESEARCH.md skeleton example:
       - Props: `variant: "table" | "chart" | "cards" | "mixed"`
       - All variants use `animate-pulse` for shimmer effect (per Claude's discretion: Tailwind built-in pulse)
       - "table": Header row of 6 bars + 8 data rows of 6 bars each, varying opacity
       - "chart": Title bar + large rectangular placeholder for chart area
       - "cards": Grid of 4 card-shaped rectangles (grid-cols-4 on lg)
       - "mixed": 4 stat cards row + chart area + text rows
       - Colors: `bg-surface-overlay` for skeleton shapes
       - Spacing: compact, using `gap-md`, `p-md`, `space-y-xs`

    5. **Create `src/components/ui/EditionBadge.tsx`** — Header badge:
       - Props: `edition: string` (e.g., "February 2026")
       - Renders: `"{edition} Edition"` in a small pill/badge
       - Styled: `bg-brand-accent/10 text-brand-accent text-xs font-medium px-sm py-xs rounded`
       - This goes in the TopBar

    6. **Create `src/components/ui/DataRecencyTag.tsx`** — Per-section data freshness:
       - Props: `dataAsOf: string` (e.g., "Q3 FY25"), `className?: string`
       - Renders: `"Data as of {dataAsOf}"` in muted text
       - Styled: `text-text-muted text-xs` with a small clock icon or bullet prefix

    7. **Create `src/components/charts/ChartTooltip.tsx`** — Custom Recharts tooltip:
       - Implements the Recharts custom tooltip interface (`active`, `payload`, `label` props)
       - Background: `bg-surface-overlay` with border and shadow
       - Text: `text-xs`, uses `text-text-primary` for values and `text-text-secondary` for labels
       - Compact padding for high-density feel
       - Lists each series name + formatted value
       - Style: Dark, semi-transparent card matching Bloomberg aesthetic

    8. **Create `src/components/charts/ChartAnnotation.tsx`** — Annotation helper:
       - This is a configuration helper, not a standalone component. Export a function `createAnnotation(key, x, y, label)` that returns the props object for Recharts `<ReferenceDot>` with custom label positioning.
       - The actual rendering happens inside TrendLineChart/BarComparisonChart using `<ReferenceDot>` with these props.
       - Label styling: `text-xs`, `fill: var(--color-text-primary)`, bold, positioned above the dot
       - Dot styling: `fill: var(--color-brand-accent)`, white stroke, small radius

    9. **Create `src/components/charts/TrendLineChart.tsx`** — Follow RESEARCH.md Pattern 4:
       - Props: `data: Array<Record<string, unknown>>`, `lines: Array<{ dataKey: string; colorVar: string; label: string }>`, `xDataKey: string`, `annotations?: ChartAnnotation[]`, `onPointClick?: (dataKey, payload) => void`, `height?: number`
       - Uses `<ResponsiveContainer width="100%" height={height ?? 240}>` — ALWAYS set explicit height (RESEARCH.md Pitfall 7)
       - ALL colors via `var()` CSS custom properties — NEVER hardcode hex (RESEARCH.md anti-pattern)
         - Grid stroke: `var(--color-text-muted)` with low opacity
         - Axis tick fill: `var(--color-text-secondary)`
         - Line stroke/dot: `var(${line.colorVar})` where colorVar is like `--color-chart-1`
       - **Annotation rendering:** When `annotations` prop is provided, map over the annotations array and render a `<ReferenceDot>` for each one using the `createAnnotation(annotation.key, annotation.x, annotation.y, annotation.label)` helper from ChartAnnotation.tsx. Spread the returned props onto `<ReferenceDot>`. This renders labeled dots at specific data points for inline callout annotations per the user's locked "inline annotations with callout arrows" decision.
       - Annotation dots use `var(--color-brand-accent)` — changes with tenant
       - Custom tooltip: `<Tooltip content={<ChartTooltip />} />`
       - Active dot onClick handler for drill-down (per user decision: "click to drill down")
       - Compact margins for high density: `{ top: 8, right: 8, bottom: 4, left: 0 }`
       - Tick font size: 11px (matching --text-xs)

    10. **Create `src/components/charts/BarComparisonChart.tsx`** — Bar chart wrapper:
        - Props: `data: Array<Record<string, unknown>>`, `bars: Array<{ dataKey: string; colorVar: string; label: string }>`, `xDataKey: string`, `annotations?: ChartAnnotation[]`, `onBarClick?: (dataKey, payload) => void`, `height?: number`, `stacked?: boolean`
        - Uses Recharts `<BarChart>` with `<Bar>` components
        - ALL colors via `var()` — bar fills use `var(${bar.colorVar})`
        - Custom tooltip with ChartTooltip
        - onClick handler on bars for drill-down
        - Compact styling matching TrendLineChart
        - Optional `stacked` prop for stacked bar charts
        - `<ResponsiveContainer>` with explicit height
        - When `annotations` prop is provided, map over the annotations array and render `<ReferenceDot>` for each using `createAnnotation` helper (same pattern as TrendLineChart)

    11. **Update TopBar to use EditionBadge component:** Import `EditionBadge` from `src/components/ui/EditionBadge.tsx` and replace the inline edition badge `<span>` (created in Plan 01) with `<EditionBadge edition="February 2026" />`.
  </action>
  <verify>
    Run `npx tsc --noEmit` — all components compile cleanly.
    Run `npm run dev` — verify in browser:
    1. EditionBadge appears in TopBar with brand accent styling
    2. Temporarily render a demo section in one of the placeholder routes that uses StatCard, TrendIndicator, PerformanceTag, SectionSkeleton, TrendLineChart, and BarComparisonChart with sample data. Confirm:
       - StatCard shows formatted value with trend arrow
       - PerformanceTag shows colored badge
       - Charts render with the professional color palette
       - Chart annotations render as ReferenceDot elements at specified data points
       - Switching tenant URL changes chart accent colors
       - Skeleton shimmer animation works
    3. After verification, remove the temporary demo content (or keep it behind a /pricio/report/demo route for testing)
    Run `npx vitest run` — all formatter tests still pass.
  </verify>
  <done>
    6 shared UI primitives (StatCard, TrendIndicator, PerformanceTag, SectionSkeleton, EditionBadge, DataRecencyTag) render correctly with brand tokens and formatted financial numbers. 4 chart components (TrendLineChart, BarComparisonChart, ChartAnnotation, ChartTooltip) render using CSS custom property colors that change when switching tenants. TrendLineChart and BarComparisonChart render ReferenceDot annotations from annotations array using createAnnotation helper. EditionBadge visible in TopBar. All TypeScript compiles. All tests pass.
  </done>
</task>

</tasks>

<verification>
1. `npx vitest run` — all formatter tests pass
2. `npx tsc --noEmit` — zero TypeScript errors across all type files and components
3. All 10 section data interfaces exist in sections.ts with discriminated union
4. StatCard renders label + formatted value + trend indicator with brand colors
5. PerformanceTag renders outperform (green), inline (gray), underperform (red) badges
6. TrendIndicator shows directional arrows with semantic colors
7. SectionSkeleton shows shimmer animation in 4 variants (table, chart, cards, mixed)
8. TrendLineChart and BarComparisonChart render with CSS variable colors
9. TrendLineChart renders ReferenceDot annotations from annotations array via createAnnotation
10. Switching tenant URL changes chart accent/annotation colors
11. EditionBadge shows edition text in TopBar with brand accent styling
12. DataRecencyTag renders data freshness indicator
13. ChartTooltip displays formatted values on hover
</verification>

<success_criteria>
- TypeScript data contracts define JSON shapes for all 10 section payloads with discriminated union
- All 7 formatter functions work correctly with Indian financial numbers (tested)
- 6 shared UI primitives render with brand tokens and are ready for use in content modules
- 2 chart wrappers consume CSS custom properties and re-theme when tenant changes
- Chart annotations render as ReferenceDot elements using createAnnotation helper
- Chart tooltips work for inline data callouts
- Everything compiles and tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-and-architecture/01-02-SUMMARY.md`
</output>