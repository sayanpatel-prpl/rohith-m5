/**
 * ETL: V1 Consumer Durables Intelligence → V2 React Mock Data
 *
 * Reads V1 data.js + news-data.js, transforms to V2 TypeScript mock files.
 * Output conforms to src/types/sections.ts interfaces.
 *
 * Usage: node scripts/etl-v1-to-v2-mocks.mjs
 */

import fs from "fs";
import path from "path";
import vm from "vm";
import { fileURLToPath } from "url";

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const ROOT = path.join(__dirname, "..");
const V1_DIR = path.join(ROOT, "consumer-durables-intelligence", "assets", "js");
const MOCK_DIR = path.join(ROOT, "src", "data", "mock");

// ============================================================================
// 1. LOAD V1 DATA
// ============================================================================

function loadV1Data() {
  let dataContent = fs.readFileSync(path.join(V1_DIR, "data.js"), "utf-8");
  let newsContent = fs.readFileSync(path.join(V1_DIR, "news-data.js"), "utf-8");

  // Replace const/let with var so vm.runInNewContext exposes them on the context
  dataContent = dataContent.replace(/^const /gm, "var ").replace(/^let /gm, "var ");
  newsContent = newsContent.replace(/^const /gm, "var ").replace(/^let /gm, "var ");

  const ctx = {};
  vm.runInNewContext(dataContent, ctx);
  vm.runInNewContext(newsContent, ctx);

  return { DATA: ctx.DATA, NEWS_DATA: ctx.NEWS_DATA };
}

// ============================================================================
// 2. SHARED HELPERS
// ============================================================================

const V1_TO_V2_ID = {
  bajaj_elec: "bajaj",
  ttk_prestige: "ttk",
  bosch_jch: "jch",
};

function mapId(v1Id) {
  return V1_TO_V2_ID[v1Id] || v1Id;
}

/** Escape strings for embedding in TypeScript (JSON.stringify handles this) */
function writeTs(filePath, importLine, typeName, data) {
  const json = JSON.stringify(data, null, 2);
  const content = `${importLine}

// Generated by scripts/etl-v1-to-v2-mocks.mjs — ${new Date().toISOString().split("T")[0]}
// Source: consumer-durables-intelligence/assets/js/data.js

const data: ${typeName} = ${json};

export default data;
`;
  fs.writeFileSync(path.join(MOCK_DIR, filePath), content, "utf-8");
  console.log(`  ✓ ${filePath} (${data.deals?.length ?? data.cxoChanges?.length ?? "—"} items)`);
}

const NOW_ISO = "2026-02-22T00:00:00Z";

// ============================================================================
// 3. DEALS TRANSFORMER
// ============================================================================

const DEAL_TYPE_MAP = {
  "M&A": "M&A",
  "Stake Sale": "M&A",
  Divestiture: "M&A",
  JV: "M&A",
  Buyback: "M&A",
  Demerger: "M&A",
  "Land Allotment": "M&A",
  "PE Investment": "PE/VC",
  QIP: "PE/VC",
  "Fund Raise": "PE/VC",
  "Strategic Investment": "PE/VC",
  Capex: "PE/VC",
  "Govt Incentive": "PE/VC",
};

function deriveAmAngle(deal) {
  const type = deal.type;
  const status = (deal.status || "").toLowerCase();
  const rationale = (deal.rationale || "").toLowerCase();

  if (type === "Divestiture" || type === "Demerger") return "Carve-out Advisory";
  if (
    status === "failed" ||
    status === "rejected" ||
    status === "shelved" ||
    rationale.includes("distress") ||
    rationale.includes("restructur")
  )
    return "Restructuring";
  if (type === "M&A" || type === "JV")
    return rationale.includes("integrat") ? "Integration Support" : "CDD Opportunity";
  if (type === "Stake Sale" || type === "Buyback") return "Valuation";
  return "Valuation"; // PE/VC, QIP, Fund Raise, etc.
}

function truncate(str, maxLen = 120) {
  if (!str || str.length <= maxLen) return str || "";
  return str.slice(0, maxLen).replace(/\s+\S*$/, "") + "…";
}

function transformDeals(DATA) {
  const deals = DATA.deals.map((d, i) => {
    const v2Type =
      DEAL_TYPE_MAP[d.type] ||
      ((d.status || "").toLowerCase().includes("fail") ? "distressed" : "M&A");

    const amAngle = deriveAmAngle(d);

    return {
      id: `deal-${String(i + 1).padStart(3, "0")}`,
      type: v2Type,
      parties: [d.company, d.buyer].filter(Boolean),
      valueCr: d.dealSize ?? null,
      rationale: d.rationale || d.target || "",
      date: d.date,
      source: d.sourceName || "Open source research",
      amAngle,
      amAngleRationale: truncate(d.rationale),
    };
  });

  // Generate AI patterns from deal clusters
  const mnaDeals = deals.filter((d) => d.type === "M&A");
  const peDeals = deals.filter((d) => d.type === "PE/VC");
  const recentDeals = deals.filter((d) => d.date >= "2025-01-01");

  const aiPatterns = [];

  if (mnaDeals.length >= 3) {
    aiPatterns.push({
      pattern: "M&A consolidation wave across consumer durables",
      confidence: "high",
      supportingDeals: mnaDeals.slice(0, 5).map((d) => d.id),
      explanation: `${mnaDeals.length} M&A transactions tracked across the sector — stake sales, divestitures, and strategic acquisitions indicate ongoing consolidation. Key acquirers actively reshaping category positions.`,
    });
  }

  if (peDeals.length >= 3) {
    aiPatterns.push({
      pattern: "PLI-driven capital raises and strategic investments",
      confidence: "high",
      supportingDeals: peDeals.slice(0, 5).map((d) => d.id),
      explanation: `${peDeals.length} PE/VC and capital raise transactions linked to PLI capacity expansion, QIPs, and strategic investments. Government incentive structure attracting institutional capital.`,
    });
  }

  // Distress signals
  const distressDeals = deals.filter(
    (d) => d.amAngle === "Restructuring" || d.amAngle === "Carve-out Advisory"
  );
  if (distressDeals.length >= 2) {
    aiPatterns.push({
      pattern: "Emerging stress signals triggering ownership changes",
      confidence: "medium",
      supportingDeals: distressDeals.map((d) => d.id),
      explanation: `${distressDeals.length} transactions flagged for restructuring or carve-out signals — divestitures, failed deals, and promoter stake changes suggest financial stress at select companies.`,
    });
  }

  if (recentDeals.length >= 3) {
    aiPatterns.push({
      pattern: "Deal activity acceleration in CY2025-26",
      confidence: "high",
      supportingDeals: recentDeals.slice(0, 6).map((d) => d.id),
      explanation: `${recentDeals.length} deals since Jan 2025, reflecting heightened M&A and capital markets activity. Industry entering a structural consolidation and investment phase.`,
    });
  }

  return {
    section: "deals-transactions",
    dataAsOf: "Q3 FY26",
    lastUpdated: NOW_ISO,
    deals,
    aiPatterns,
  };
}

// ============================================================================
// 4. LEADERSHIP TRANSFORMER
// ============================================================================

const CXO_CHANGE_TYPES = new Set([
  "CEO Change",
  "CXO Hire",
  "CXO Exodus",
  "CFO Exit",
  "CFO Change",
]);
const BOARD_CHANGE_TYPES = new Set(["Board Reshuffle", "Chairman Elevation"]);
const PROMOTER_CHANGE_TYPES = new Set([
  "Promoter Stake Change",
  "Promoter Succession",
  "Ownership Change",
]);

function parsePersonField(person, changeType) {
  const personStr = person || "";
  let incoming = null;
  let outgoing = null;

  if (personStr.includes("/")) {
    const parts = personStr.split("/").map((s) => s.trim());
    incoming = parts[0].replace(/\(.*?\)/g, "").trim() || null;
    outgoing = parts[1].replace(/\(.*?\)/g, "").trim() || null;
  } else if (
    changeType.includes("Hire") ||
    changeType.includes("Elevation") ||
    changeType.includes("Succession")
  ) {
    incoming = personStr.replace(/\(.*?\)/g, "").trim() || null;
  } else if (changeType.includes("Exit") || changeType.includes("Exodus")) {
    outgoing = personStr.replace(/\(.*?\)/g, "").trim() || null;
  } else {
    // Default: treat as involving person
    incoming = personStr.replace(/\(.*?\)/g, "").trim() || null;
  }

  return { incoming, outgoing };
}

function deriveRole(lc) {
  const change = lc.change || "";
  const detail = (lc.detail || "").toLowerCase();
  if (change.includes("CEO")) return "Managing Director & CEO";
  if (change.includes("CFO")) return "Chief Financial Officer";
  if (change.includes("Chairman")) return "Chairperson";
  if (detail.includes("cmo") || detail.includes("marketing")) return "Chief Marketing Officer";
  if (detail.includes("coo") || detail.includes("operations")) return "Chief Operating Officer";
  if (detail.includes("independent director")) return "Independent Director";
  if (detail.includes("board")) return "Board Member";
  return "Senior Leadership";
}

function mapConfidence(riskLevel) {
  const rl = (riskLevel || "").toLowerCase();
  if (rl === "high") return "high";
  if (rl === "medium") return "medium";
  return "low";
}

function extractPercentages(text) {
  const matches = [...(text || "").matchAll(/(\d+\.?\d*)%/g)].map((m) =>
    parseFloat(m[1])
  );
  return matches;
}

function transformLeadership(DATA) {
  const changes = DATA.leadershipChanges || [];

  const cxoChanges = [];
  const boardReshuffles = [];
  const promoterStakeChanges = [];
  const auditorFlags = [];
  const aiRiskFlags = [];
  const companyRiskMap = {};

  for (const lc of changes) {
    const company = lc.company;

    if (CXO_CHANGE_TYPES.has(lc.change)) {
      const { incoming, outgoing } = parsePersonField(lc.person, lc.change);
      cxoChanges.push({
        company,
        role: deriveRole(lc),
        incoming,
        outgoing,
        effectiveDate: lc.date,
        context: lc.detail || "",
      });
    } else if (BOARD_CHANGE_TYPES.has(lc.change)) {
      boardReshuffles.push({
        company,
        change: lc.detail || lc.change,
        date: lc.date,
        significance: mapConfidence(lc.riskLevel),
      });
    } else if (PROMOTER_CHANGE_TYPES.has(lc.change)) {
      const pcts = extractPercentages(lc.detail);
      const previousPct = pcts.length >= 2 ? pcts[0] : null;
      const currentPct = pcts.length >= 2 ? pcts[1] : pcts[0] ?? null;
      const changePct =
        previousPct != null && currentPct != null
          ? Math.round((currentPct - previousPct) * 100) / 100
          : 0;

      // Find company promoter holding from master data as fallback
      const companyData = DATA.companies.find(
        (c) => c.name === company || c.id === lc.companyId
      );
      const fallbackPct = companyData?.promoterHolding ?? currentPct ?? 0;

      promoterStakeChanges.push({
        company,
        promoterGroup: lc.person || "Promoter Group",
        previousPct: previousPct ?? fallbackPct,
        currentPct: currentPct ?? fallbackPct,
        changePct,
        context: lc.detail || "",
        amServiceLineImplication: lc.implication || "",
      });
    } else if (lc.change === "Governance Flag") {
      const detail = (lc.detail || "").toLowerCase();
      if (
        detail.includes("audit") ||
        detail.includes("qualification") ||
        detail.includes("going concern") ||
        detail.includes("related-party") ||
        detail.includes("related party")
      ) {
        auditorFlags.push({
          company,
          flag: lc.detail || lc.change,
          severity: mapConfidence(lc.riskLevel),
          details: lc.implication || lc.detail || "",
        });
      } else {
        boardReshuffles.push({
          company,
          change: lc.detail || lc.change,
          date: lc.date,
          significance: mapConfidence(lc.riskLevel),
        });
      }
    } else if (lc.change === "Demerger") {
      boardReshuffles.push({
        company,
        change: lc.detail || `Demerger: ${lc.person || ""}`,
        date: lc.date,
        significance: mapConfidence(lc.riskLevel),
      });
    }

    // Track risk for aiRiskFlags and governanceRiskScores
    if (lc.riskLevel === "High") {
      aiRiskFlags.push({
        company,
        riskType: `${lc.change} Risk`,
        confidence: "high",
        explanation: lc.implication || lc.detail || "",
      });
    }

    // Accumulate per-company risk
    if (!companyRiskMap[company]) companyRiskMap[company] = { events: [], maxRisk: "low" };
    const entry = companyRiskMap[company];
    entry.events.push(lc.detail || lc.change);
    const rl = (lc.riskLevel || "").toLowerCase();
    if (rl === "high") entry.maxRisk = "red";
    else if (rl === "medium" && entry.maxRisk !== "red") entry.maxRisk = "amber";
  }

  // Build governance risk scores
  const governanceRiskScores = Object.entries(companyRiskMap).map(
    ([company, info]) => {
      const score = info.maxRisk === "red" ? "red" : info.maxRisk === "amber" ? "amber" : "green";
      const serviceLineMap = {
        red: "Turnaround & Restructuring Advisory",
        amber: "Governance & Risk Advisory",
        green: "Growth Strategy",
      };
      return {
        company,
        score,
        factors: info.events.slice(0, 4).map((e) => truncate(e, 100)),
        amServiceLine: serviceLineMap[score],
      };
    }
  );

  return {
    section: "leadership-governance",
    dataAsOf: "Q3 FY26",
    lastUpdated: NOW_ISO,
    cxoChanges,
    boardReshuffles,
    promoterStakeChanges,
    auditorFlags,
    aiRiskFlags,
    governanceRiskScores,
  };
}

// ============================================================================
// 5. COMPETITIVE MOVES TRANSFORMER
// ============================================================================

function deriveCategory(title, detail) {
  const text = ((title || "") + " " + (detail || "")).toLowerCase();
  if (text.match(/\bac\b|hvac|cooling|air condition|split|window ac|inverter ac/))
    return "Air Conditioning";
  if (text.match(/\bfan|ceiling|bldc/)) return "Fans";
  if (text.match(/cable|wire|switchgear/)) return "Cables & Wires";
  if (text.match(/kitchen|cooker|cookware|mixer|grinder|gas stove|chimney|pressure/))
    return "Kitchen Appliances";
  if (text.match(/light|led|luminaire|switch/)) return "Lighting & Electricals";
  if (text.match(/refrigerat|fridge|washing machine|washer|laundry|microwave/))
    return "Home Appliances";
  if (text.match(/solar|ev |charger|bess|battery/)) return "New Energy";
  if (text.match(/smart|iot|connect/)) return "Smart Home";
  if (text.match(/water heater|geyser|water purif/)) return "Water Solutions";
  if (text.match(/cooler|desert/)) return "Air Coolers";
  return "Consumer Durables";
}

function deriveStatus(detail) {
  const d = (detail || "").toLowerCase();
  if (d.includes("launch") || d.includes("operational") || d.includes("live")) return "launched";
  if (d.includes("pilot") || d.includes("trial") || d.includes("testing")) return "piloting";
  return "announced";
}

function transformCompetitive(DATA) {
  const moves = DATA.competitiveMoves || [];

  const productLaunches = [];
  const pricingActions = [];
  const d2cInitiatives = [];
  const qcPartnerships = [];
  const otherMoves = [];

  const QC_PARTNERS = new Set([
    "blinkit", "zepto", "swiggy", "flipkart", "amazon", "jiomart",
    "bigbasket", "dunzo", "quick commerce",
  ]);

  for (const cm of moves) {
    const type = cm.type;
    const titleLower = (cm.title || "").toLowerCase();
    const detailLower = (cm.detail || "").toLowerCase();
    const combined = titleLower + " " + detailLower;

    // Check for QC/retail partnerships first
    if (type === "Partnership" && [...QC_PARTNERS].some((p) => combined.includes(p))) {
      const partnerMatch = [...QC_PARTNERS].find((p) => combined.includes(p));
      qcPartnerships.push({
        company: cm.company,
        partner: partnerMatch
          ? partnerMatch.charAt(0).toUpperCase() + partnerMatch.slice(1)
          : "Retail Partner",
        scope: cm.detail || cm.title,
        status: combined.includes("active") || combined.includes("live")
          ? "active"
          : combined.includes("rumor")
            ? "rumored"
            : "announced",
      });
      continue;
    }

    // Check for D2C initiatives
    if (
      combined.includes("d2c") ||
      combined.includes("direct-to-consumer") ||
      combined.includes("direct to consumer") ||
      combined.includes("own website") ||
      combined.includes("online store") ||
      combined.includes("subscription")
    ) {
      d2cInitiatives.push({
        company: cm.company,
        initiative: cm.title,
        channel: combined.includes("website") || combined.includes("portal")
          ? "Own website"
          : combined.includes("quick") || combined.includes("blinkit") || combined.includes("zepto")
            ? "Quick Commerce"
            : "Digital Direct",
        status: deriveStatus(cm.detail),
        details: cm.detail || "",
      });
      continue;
    }

    // Check for pricing actions
    if (
      combined.includes("price hike") ||
      combined.includes("price increase") ||
      combined.includes("price cut") ||
      combined.includes("discount") ||
      combined.includes("pricing")
    ) {
      const isDecrease = combined.includes("cut") || combined.includes("discount");
      const magMatch = combined.match(/(\d+\.?\d*)%/);
      pricingActions.push({
        company: cm.company,
        action: isDecrease ? "decrease" : "increase",
        category: deriveCategory(cm.title, cm.detail),
        magnitudePct: magMatch ? parseFloat(magMatch[1]) : null,
        context: cm.detail || cm.title,
      });
      continue;
    }

    // Product launches and strategic moves
    if (
      type === "Product Launch" ||
      type === "Product Strategy" ||
      type === "Product Vision" ||
      type === "Product Investment" ||
      type === "Product Pivot" ||
      type === "Technology Direction"
    ) {
      productLaunches.push({
        company: cm.company,
        product: cm.title,
        category: deriveCategory(cm.title, cm.detail),
        positioningNote: cm.detail || "",
        date: cm.date,
      });
      continue;
    }

    // Everything else goes to productLaunches as strategic moves
    if (type === "CXO Statement") {
      // Skip CXO statements — they're not product launches
      otherMoves.push(cm);
      continue;
    }

    // Plant expansions, M&A, PLI/Govt, Partnerships → product launches as catch-all
    productLaunches.push({
      company: cm.company,
      product: cm.title,
      category: deriveCategory(cm.title, cm.detail),
      positioningNote: cm.detail || "",
      date: cm.date,
    });
  }

  // Generate cluster analysis from company groupings
  const clusterAnalysis = [
    {
      cluster: "Premium Innovators",
      companies: ["Havells India", "Blue Star Limited", "TTK Prestige Limited"],
      characteristics:
        "Premium brand positioning, high R&D spend, >30% premium product mix, strong D2C channels",
      outlook:
        "Well-positioned for premiumization trend. Margin expansion through mix shift. Risk: premium demand elasticity in downturn.",
    },
    {
      cluster: "Scale Manufacturers (OEM/ODM)",
      companies: ["Dixon Technologies", "Amber Enterprises", "Johnson Controls-Hitachi"],
      characteristics:
        "Contract manufacturing, PLI beneficiaries, B2B model, capacity-driven growth",
      outlook:
        "Volume growth from PLI and import substitution. Margin risk from commodity pass-through. Amber expanding into components.",
    },
    {
      cluster: "Mass-Market Electricals",
      companies: [
        "Crompton Greaves",
        "Bajaj Electricals",
        "V-Guard Industries",
        "Orient Electric",
      ],
      characteristics:
        "GT-heavy distribution, mass-market pricing, fan/lighting/small appliance focus",
      outlook:
        "Consolidation ongoing (Crompton-Butterfly, V-Guard-Sunflame). Premium fan shift is key margin lever. Rural recovery needed for volume growth.",
    },
    {
      cluster: "Turnaround Candidates",
      companies: ["IFB Industries", "Butterfly Gandhimathi", "Symphony Limited"],
      characteristics:
        "Governance/financial stress signals, sub-sector leadership but operational challenges",
      outlook:
        "IFB: auditor flags + board concerns. Butterfly: negative OCF. Symphony: international losses. All need operational turnaround before growth reinvestment.",
    },
  ];

  return {
    section: "competitive-moves",
    dataAsOf: "Q3 FY26",
    lastUpdated: NOW_ISO,
    productLaunches,
    pricingActions,
    d2cInitiatives,
    qcPartnerships,
    clusterAnalysis,
  };
}

// ============================================================================
// 6. OPERATIONS TRANSFORMER
// ============================================================================

function transformOperations(DATA) {
  const moves = DATA.competitiveMoves || [];
  const opMetrics = DATA.operationalMetrics || {};

  // Manufacturing capacity from plant expansion moves
  const manufacturingCapacity = moves
    .filter((cm) => cm.type === "Plant Expansion")
    .map((cm) => {
      const detail = cm.detail || "";
      // Extract investment amount
      const invMatch = detail.match(/[₹Rs]\s*([\d,.]+)\s*(?:Cr|crore)/i);
      const investmentCr = invMatch ? parseFloat(invMatch[1].replace(/,/g, "")) : null;
      // Extract timeline
      const timeMatch = detail.match(/(?:by |operational |target )([QH]\d\s*FY\d{2}|FY\d{2,4}|20\d{2})/i);
      const timeline = timeMatch ? timeMatch[1] : "TBD";

      return {
        company: cm.company,
        facility: cm.title,
        action: detail.toLowerCase().includes("greenfield") ? "greenfield" : "expansion",
        investmentCr,
        timeline,
      };
    });

  // Supply chain signals from operational metrics
  const supplyChainSignals = [];
  for (const [v1Id, importDep] of Object.entries(opMetrics.importDependency || {})) {
    const v2Id = mapId(v1Id);
    const company = DATA.companies.find((c) => c.id === v1Id);
    if (!company) continue;
    const localPct = opMetrics.localizationPct?.[v1Id] ?? (100 - importDep);
    const capUtil = opMetrics.capacityUtilization?.[v1Id] ?? null;

    supplyChainSignals.push({
      company: company.name,
      signal: `Import dependency ${importDep}% — localization at ${localPct}%${capUtil ? `, capacity utilization ${capUtil}%` : ""}`,
      impact: importDep > 35 ? "negative" : importDep > 20 ? "neutral" : "positive",
      details: `Contract manufacturing: ${opMetrics.contractManufacturingPct?.[v1Id] ?? "N/A"}%. Vendor consolidation index: ${opMetrics.vendorConsolidationIndex?.[v1Id] ?? "N/A"}/100. After-sales cost: ${opMetrics.afterSalesCostPct?.[v1Id] ?? "N/A"}% of revenue.`,
    });
  }

  // Procurement shifts from PLI/Govt and Partnership moves
  const procurementShifts = [];
  const pliMoves = moves.filter(
    (cm) => cm.type === "PLI/Govt" || (cm.type === "Partnership" && (cm.detail || "").toLowerCase().includes("sourc"))
  );
  // Group by category
  const categoryGroups = {};
  for (const cm of pliMoves) {
    const cat = deriveCategory(cm.title, cm.detail);
    if (!categoryGroups[cat]) categoryGroups[cat] = { moves: [], companies: new Set() };
    categoryGroups[cat].moves.push(cm);
    categoryGroups[cat].companies.add(cm.company);
  }
  for (const [category, group] of Object.entries(categoryGroups)) {
    procurementShifts.push({
      category,
      shift: group.moves.map((m) => m.title).join("; "),
      affectedCompanies: [...group.companies],
      impact: group.moves[0]?.detail || "",
    });
  }

  // Retail footprint from company data
  const retailFootprint = [];
  for (const company of DATA.companies) {
    if (!company.dealerNetwork) continue;
    retailFootprint.push({
      company: company.name,
      action: "expansion",
      storeCount: company.dealerNetwork,
      geography: company.headquarters?.split(",")[1]?.trim() || "Pan-India",
      details: `Dealer network: ${company.dealerNetwork.toLocaleString()} points. Plants: ${company.plants}. Employees: ${company.employees?.toLocaleString() ?? "N/A"}.`,
    });
  }

  return {
    section: "operational-intelligence",
    dataAsOf: "Q3 FY26",
    lastUpdated: NOW_ISO,
    supplyChainSignals,
    manufacturingCapacity,
    procurementShifts,
    retailFootprint,
  };
}

// ============================================================================
// 7. MARKET PULSE TRANSFORMER
// ============================================================================

function transformMarketPulse(DATA) {
  const mp = DATA.marketPulse;
  const quarters = DATA.quarters;

  // Demand signals
  const demandSignals = [];
  const latestGrowth = mp.demandSignals.sectorRevenueGrowthYoY[14];
  const prevGrowth = mp.demandSignals.sectorRevenueGrowthYoY[13];
  const volGrowth = mp.demandSignals.volumeGrowth[14];
  const priceGrowth = mp.demandSignals.priceGrowth[14];

  demandSignals.push({
    channel: "Sector Aggregate",
    signal: `Sector revenue grew ${latestGrowth}% YoY in Q3 FY26 (vs ${prevGrowth}% in Q2 FY26). Growth decelerating.`,
    direction: latestGrowth > prevGrowth ? "up" : "down",
    magnitude: `+${latestGrowth}% YoY`,
    dataConfidence: "Verified",
  });

  demandSignals.push({
    channel: "Volume vs Price",
    signal: `Volume growth at ${volGrowth}% vs price growth at ${priceGrowth}%. Top-line resilience driven by price hikes and premium mix, not genuine volume expansion.`,
    direction: volGrowth >= 0 ? "flat" : "down",
    magnitude: `Vol ${volGrowth}% / Price +${priceGrowth}%`,
    dataConfidence: "Estimated",
  });

  // Add Q3 earnings signals
  for (const e of mp.q3Earnings || []) {
    demandSignals.push({
      channel: e.company,
      signal: `Revenue ₹${e.revenue} Cr (${e.yoyGrowth > 0 ? "+" : ""}${e.yoyGrowth}% YoY). EBITDA margin ${e.ebitdaMargin}%. ${e.note}`,
      direction: e.signal === "positive" ? "up" : e.signal === "negative" ? "down" : "flat",
      magnitude: `${e.yoyGrowth > 0 ? "+" : ""}${e.yoyGrowth}% YoY`,
      dataConfidence: "Verified",
    });
  }

  // Urban/rural dynamics
  const urd = mp.urbanRuralDynamics;
  demandSignals.push({
    channel: "Urban Premium",
    signal: `Urban premium demand ${urd.urbanPremiumGrowth} growth. Home improvement boom: ${urd.homeImprovementBoom.size} market, ${urd.homeImprovementBoom.cagr} CAGR to ${urd.homeImprovementBoom.target2030} by 2030.`,
    direction: "up",
    magnitude: urd.urbanPremiumGrowth,
    dataConfidence: "Management Guidance Interpretation",
  });

  demandSignals.push({
    channel: "Rural Volume",
    signal: `Rural volume recovery: "${urd.ruralVolumeRecovery}". Growth driver: ${urd.growthDriver}.`,
    direction: "flat",
    magnitude: "Fits and starts",
    dataConfidence: "Estimated",
  });

  // Input costs
  const inputCosts = [];
  const commodities = {
    Copper: mp.inputCosts.copper,
    "Steel (HR Coil)": mp.inputCosts.steel,
    Aluminum: mp.inputCosts.aluminum,
    "Polymer/Plastics": mp.inputCosts.polymer,
  };

  for (const [name, series] of Object.entries(commodities)) {
    const latest = series[14];
    const prevQ = series[13];
    const yoyQ = series[10]; // same quarter last year
    const qoqChange = prevQ ? (latest - prevQ) / prevQ : 0;
    const yoyChange = yoyQ ? (latest - yoyQ) / yoyQ : 0;

    // Find matching commodity outlook
    const outlook = (mp.commodityOutlook || []).find((c) =>
      name.toLowerCase().includes(c.commodity.toLowerCase())
    );

    inputCosts.push({
      commodity: name,
      trend: latest > prevQ ? "up" : latest < prevQ ? "down" : "flat",
      qoqChange: Math.round(qoqChange * 1000) / 1000,
      yoyChange: Math.round(yoyChange * 1000) / 1000,
      amImplication: outlook
        ? `${outlook.impact}: ${outlook.detail}`
        : `Index at ${latest} (base 100).`,
    });
  }

  // Input cost history
  const inputCostHistory = [];
  for (let i = 2; i < 15; i++) {
    if (mp.inputCosts.copper[i] == null) continue;
    inputCostHistory.push({
      period: quarters[i],
      Copper: mp.inputCosts.copper[i],
      Steel: mp.inputCosts.steel[i],
      Aluminum: mp.inputCosts.aluminum[i],
      Polymer: mp.inputCosts.polymer[i],
    });
  }

  // Margin outlook
  const latestEbitda = mp.marginOutlook.sectorAvgEbitda[14];
  const prevEbitda = mp.marginOutlook.sectorAvgEbitda[13];
  const topQ = mp.marginOutlook.topQuartile[14];
  const bottomQ = mp.marginOutlook.bottomQuartile[14];
  const marginOutlook = `Sector average EBITDA margin at ${latestEbitda}% in Q3 FY26 (vs ${prevEbitda}% QoQ). Top quartile: ${topQ}%, bottom quartile: ${bottomQ}%. Copper at $12,500/ton forecast creates 200-250 bps gross margin pressure. Steel safeguard duty adds ₹3,500-4,000/ton. Companies with backward integration (Havells, V-Guard) better insulated.`;

  // Channel mix — aggregate across companies
  const channelKeys = ["gt", "mt", "ecommerce", "d2c"];
  const channelNames = {
    gt: "General Trade",
    mt: "Modern Trade",
    ecommerce: "E-Commerce",
    d2c: "Direct-to-Consumer",
  };
  const chMix = DATA.channelMix || {};
  const b2cCompanies = Object.entries(chMix).filter(
    ([_, v]) => !v.b2b || v.b2b < 100
  );
  const channelMix = channelKeys.map((key) => {
    const values = b2cCompanies.map(([_, v]) => v[key] || 0);
    const avg = values.reduce((a, b) => a + b, 0) / (values.length || 1);
    // Estimate previous share as slightly different for trend
    const prevAvg = avg * (key === "ecommerce" || key === "d2c" ? 0.9 : 1.05);
    return {
      channel: channelNames[key],
      currentSharePct: Math.round(avg * 10) / 10,
      previousSharePct: Math.round(prevAvg * 10) / 10,
      trend: key === "ecommerce" || key === "d2c" ? "up" : "down",
    };
  });

  // A&M thought leadership — keep editorial
  const amThoughtLeadership = {
    title:
      "Consumer Durables Industry: Navigating Commodity Headwinds and Premiumization",
    summary:
      "Sector resilience driven by premiumization and distribution expansion, but genuine volume recovery remains elusive. Companies with backward integration and strong D2C channels best positioned.",
    url: "https://www.alvarezandmarsal.com/insights",
    source: "Alvarez & Marsal",
  };

  // Policy tracker
  const policyTracker = (mp.policyImpact || []).map((p) => ({
    policy: p.policy,
    status: p.impact === "positive" ? "active" : p.impact === "negative" ? "active" : "upcoming",
    impact: p.detail,
    affectedCompanies: (p.target || "")
      .split(",")
      .map((s) => s.trim())
      .filter(Boolean),
  }));

  // Seasonal patterns
  const sp = DATA.seasonalPatterns;
  const seasonalPatterns = [
    {
      pattern: "Summer AC & Cooler Surge",
      timing: "March-June",
      implication: `AC demand peaks at 160 index (vs 100 avg) in May. Pre-summer stocking starts February. Air cooler peaks at 170 in May.`,
    },
    {
      pattern: "Festival Season Appliance Demand",
      timing: "October-November",
      implication: `Washing machine demand rises to 110 index Oct-Nov. Water heater peaks at 150 in Jan. Festival offers drive conversion.`,
    },
    {
      pattern: "Fan Season Overlap",
      timing: "March-June",
      implication: `Fan demand peaks at 155 in May, closely tracking AC season. BLDC premium fans driving ASP uplift.`,
    },
  ];

  return {
    section: "market-pulse",
    dataAsOf: "Q3 FY26",
    lastUpdated: NOW_ISO,
    demandSignals,
    inputCosts,
    inputCostHistory,
    marginOutlook,
    channelMix,
    amThoughtLeadership,
    policyTracker,
    seasonalPatterns,
  };
}

// ============================================================================
// 8. DEEP DIVE TRANSFORMER
// ============================================================================

function transformDeepDive(DATA) {
  const dd = DATA.subSectorDeepDive;
  const csb = dd.costStructureBenchmark;

  const costsBreakdown = [
    {
      costItem: "Raw Materials (Materials + Stock-in-Trade)",
      sharePct: csb.rawMaterials.median,
      trendVsPrior: "up",
      notes: `Top quartile: ${csb.rawMaterials.topQuartile}%, Bottom: ${csb.rawMaterials.bottomQuartile}%. Copper +32% YoY driving material costs.`,
    },
    {
      costItem: "Employee Cost",
      sharePct: csb.employeeCost.median,
      trendVsPrior: "flat",
      notes: `Top quartile: ${csb.employeeCost.topQuartile}%, Bottom: ${csb.employeeCost.bottomQuartile}%. OEM/ODM companies (Dixon, Amber) skew lower.`,
    },
    {
      costItem: "Other Expenses (Logistics, Marketing, Overheads)",
      sharePct: csb.otherExpenses.median,
      trendVsPrior: "up",
      notes: `Top quartile: ${csb.otherExpenses.topQuartile}%, Bottom: ${csb.otherExpenses.bottomQuartile}%. D2C expansion increasing marketing spend.`,
    },
    {
      costItem: "Operating Margin (Residual)",
      sharePct: Math.round((100 - csb.totalExpenses.median) * 10) / 10,
      trendVsPrior: "flat",
      notes: `Sector median OPM ${Math.round((100 - csb.totalExpenses.median) * 10) / 10}%. Top quartile: ${Math.round((100 - csb.totalExpenses.topQuartile) * 10) / 10}%.`,
    },
  ];

  function parseBpsMidpoint(rangeStr) {
    const match = (rangeStr || "").match(/(\d+)[–-]+(\d+)/);
    if (match) return Math.round((parseInt(match[1]) + parseInt(match[2])) / 2);
    const single = (rangeStr || "").match(/(\d+)/);
    return single ? parseInt(single[1]) : 100;
  }

  const marginLevers = (dd.marginLevers || []).map((ml) => ({
    lever: ml.lever,
    impactBps: parseBpsMidpoint(ml.potentialImpact),
    feasibility:
      ml.difficulty === "Low" ? "high" : ml.difficulty === "Medium" ? "medium" : "low",
    explanation: ml.detail || "",
  }));

  // Top quartile analysis from V1 financial data
  const financials = DATA.financials;
  const companyIds = Object.keys(financials);
  const latestIdx = 14; // Q3 FY26

  function getMetricValues(metricFn) {
    return companyIds
      .map((id) => ({ id, val: metricFn(financials[id]) }))
      .filter((x) => x.val != null)
      .sort((a, b) => b.val - a.val);
  }

  function quartiles(sorted) {
    if (sorted.length < 4) return { top: sorted[0]?.val ?? 0, med: sorted[Math.floor(sorted.length / 2)]?.val ?? 0, bot: sorted[sorted.length - 1]?.val ?? 0, topNames: sorted.slice(0, 3).map((s) => DATA.companies.find((c) => c.id === s.id)?.name ?? s.id) };
    const q1 = sorted[Math.floor(sorted.length * 0.25)];
    const med = sorted[Math.floor(sorted.length * 0.5)];
    const q3 = sorted[Math.floor(sorted.length * 0.75)];
    return {
      top: q1.val,
      med: med.val,
      bot: q3.val,
      topNames: sorted.slice(0, 3).map((s) => DATA.companies.find((c) => c.id === s.id)?.name ?? s.id),
    };
  }

  const ebitdaVals = getMetricValues((f) => f.ebitdaMargin?.[latestIdx]);
  const ebitdaQ = quartiles(ebitdaVals);

  const wcdVals = getMetricValues((f) => f.workingCapDays?.[latestIdx]);
  // For WCD, lower is better — reverse sort
  wcdVals.sort((a, b) => a.val - b.val);
  const wcdQ = quartiles(wcdVals);

  const roceVals = getMetricValues((f) => f.roce?.[latestIdx]);
  const roceQ = quartiles(roceVals);

  const topQuartileAnalysis = [
    {
      metric: "EBITDA Margin",
      topQuartileValue: ebitdaQ.top,
      medianValue: ebitdaQ.med,
      bottomQuartileValue: ebitdaQ.bot,
      unit: "%",
      topPerformers: ebitdaQ.topNames,
    },
    {
      metric: "Working Capital Days",
      topQuartileValue: wcdQ.top,
      medianValue: wcdQ.med,
      bottomQuartileValue: wcdQ.bot,
      unit: "days",
      topPerformers: wcdQ.topNames,
    },
    {
      metric: "Return on Capital Employed",
      topQuartileValue: roceQ.top,
      medianValue: roceQ.med,
      bottomQuartileValue: roceQ.bot,
      unit: "%",
      topPerformers: roceQ.topNames,
    },
  ];

  return {
    section: "sub-sector-deep-dive",
    dataAsOf: "Q3 FY26",
    lastUpdated: NOW_ISO,
    subSector: dd.title || "Consumer Durables",
    costsBreakdown,
    marginLevers,
    topQuartileAnalysis,
  };
}

// ============================================================================
// 9. MAIN — RUN ALL TRANSFORMERS
// ============================================================================

function main() {
  console.log("Loading V1 data...");
  const { DATA, NEWS_DATA } = loadV1Data();
  console.log(
    `  Loaded: ${DATA.companies.length} companies, ${DATA.deals.length} deals, ${DATA.leadershipChanges.length} leadership, ${DATA.competitiveMoves.length} competitive, ${NEWS_DATA?.items?.length ?? 0} news`
  );

  console.log("\nTransforming...");

  // Deals
  const dealsData = transformDeals(DATA);
  writeTs(
    "deals.ts",
    'import type { DealsTransactionsData } from "../../types/sections";',
    "DealsTransactionsData",
    dealsData
  );
  console.log(`    ${dealsData.deals.length} deals, ${dealsData.aiPatterns.length} patterns`);

  // Leadership
  const leadershipData = transformLeadership(DATA);
  writeTs(
    "leadership.ts",
    'import type { LeadershipGovernanceData } from "../../types/sections";',
    "LeadershipGovernanceData",
    leadershipData
  );
  console.log(
    `    ${leadershipData.cxoChanges.length} CXO, ${leadershipData.boardReshuffles.length} board, ${leadershipData.promoterStakeChanges.length} promoter, ${leadershipData.auditorFlags.length} auditor, ${leadershipData.aiRiskFlags.length} risk flags, ${leadershipData.governanceRiskScores.length} scores`
  );

  // Competitive
  const competitiveData = transformCompetitive(DATA);
  writeTs(
    "competitive.ts",
    'import type { CompetitiveMovesData } from "../../types/sections";',
    "CompetitiveMovesData",
    competitiveData
  );
  console.log(
    `    ${competitiveData.productLaunches.length} launches, ${competitiveData.pricingActions.length} pricing, ${competitiveData.d2cInitiatives.length} D2C, ${competitiveData.qcPartnerships.length} QC`
  );

  // Operations
  const operationsData = transformOperations(DATA);
  writeTs(
    "operations.ts",
    'import type { OperationalIntelligenceData } from "../../types/sections";',
    "OperationalIntelligenceData",
    operationsData
  );
  console.log(
    `    ${operationsData.supplyChainSignals.length} supply chain, ${operationsData.manufacturingCapacity.length} capacity, ${operationsData.procurementShifts.length} procurement, ${operationsData.retailFootprint.length} retail`
  );

  // Market Pulse
  const marketPulseData = transformMarketPulse(DATA);
  writeTs(
    "market-pulse.ts",
    'import type { MarketPulseData } from "../../types/sections";',
    "MarketPulseData",
    marketPulseData
  );
  console.log(
    `    ${marketPulseData.demandSignals.length} demand, ${marketPulseData.inputCosts.length} costs, ${marketPulseData.channelMix.length} channels`
  );

  // Deep Dive
  const deepDiveData = transformDeepDive(DATA);
  writeTs(
    "deep-dive.ts",
    'import type { SubSectorDeepDiveData } from "../../types/sections";',
    "SubSectorDeepDiveData",
    deepDiveData
  );
  console.log(
    `    ${deepDiveData.costsBreakdown.length} costs, ${deepDiveData.marginLevers.length} levers, ${deepDiveData.topQuartileAnalysis.length} quartiles`
  );

  console.log("\n✓ ETL complete. Run 'npm run build' to verify TypeScript compilation.");
}

main();
