---
phase: 05-market-context-and-operations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/sections.ts
  - src/data/mock/market-pulse.ts
  - src/sections/market-pulse/MarketPulse.tsx
  - src/sections/market-pulse/DemandSignals.tsx
  - src/sections/market-pulse/InputCostTrends.tsx
  - src/sections/market-pulse/MarginOutlook.tsx
  - src/sections/market-pulse/ChannelMix.tsx
  - src/components/charts/ChartLegend.tsx
autonomous: true

must_haves:
  truths:
    - "User sees 4 demand signal StatCards with channel name, trend direction arrow, and magnitude text"
    - "User sees a multi-line chart overlaying steel, copper, plastics, aluminium price indices over 7 quarters"
    - "User sees QoQ and YoY percentage changes displayed alongside each commodity in the input cost section"
    - "User sees a margin outlook narrative paragraph with contextual detail"
    - "User sees a side-by-side bar chart comparing current vs previous channel share percentages"
    - "Market Pulse data is NOT filtered when company filter is active (sector-wide view)"
  artifacts:
    - path: "src/sections/market-pulse/MarketPulse.tsx"
      provides: "Main Market Pulse section with dashboard grid layout"
      min_lines: 40
    - path: "src/sections/market-pulse/DemandSignals.tsx"
      provides: "4-column StatCard grid for demand signals"
      min_lines: 20
    - path: "src/sections/market-pulse/InputCostTrends.tsx"
      provides: "Multi-line TrendLineChart with commodity overlays and QoQ/YoY labels"
      min_lines: 40
    - path: "src/sections/market-pulse/MarginOutlook.tsx"
      provides: "Margin narrative with TrendIndicators"
      min_lines: 15
    - path: "src/sections/market-pulse/ChannelMix.tsx"
      provides: "BarComparisonChart for channel share shifts"
      min_lines: 30
    - path: "src/components/charts/ChartLegend.tsx"
      provides: "Custom Recharts legend component matching design system"
      exports: ["ChartLegend"]
    - path: "src/types/sections.ts"
      provides: "Extended MarketPulseData with inputCostHistory field"
      contains: "inputCostHistory"
    - path: "src/data/mock/market-pulse.ts"
      provides: "Historical input cost time series data (7 quarters)"
      contains: "inputCostHistory"
  key_links:
    - from: "src/sections/market-pulse/MarketPulse.tsx"
      to: "src/hooks/use-filtered-data.ts"
      via: "useFilteredData('market-pulse')"
      pattern: "useFilteredData.*market-pulse"
    - from: "src/sections/market-pulse/InputCostTrends.tsx"
      to: "src/components/charts/TrendLineChart.tsx"
      via: "TrendLineChart with inputCostHistory data"
      pattern: "TrendLineChart"
    - from: "src/sections/market-pulse/ChannelMix.tsx"
      to: "src/components/charts/BarComparisonChart.tsx"
      via: "BarComparisonChart with channel share data"
      pattern: "BarComparisonChart"
    - from: "src/sections/market-pulse/DemandSignals.tsx"
      to: "src/components/ui/StatCard.tsx"
      via: "StatCard per demand signal"
      pattern: "StatCard"
---

<objective>
Build the Market Pulse section module -- the macro industry context dashboard showing demand signals, input cost trends, margin outlook, and channel mix shifts for the Indian Consumer Durables sector.

Purpose: Users need sector-wide context to understand the macro environment before drilling into company-specific data. Market Pulse answers "what is happening in the industry?" with demand direction, commodity costs, margin pressure, and channel shifts.

Output: Fully rendered Market Pulse section replacing the Phase 2 placeholder, with 4 sub-sections in a dashboard grid layout.
</objective>

<execution_context>
@/Users/prateekkurkanji/.claude/get-shit-done/workflows/execute-plan.md
@/Users/prateekkurkanji/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/05-market-context-and-operations/05-CONTEXT.md
@.planning/phases/05-market-context-and-operations/05-RESEARCH.md

@src/types/sections.ts
@src/data/mock/market-pulse.ts
@src/hooks/use-filtered-data.ts
@src/components/charts/TrendLineChart.tsx
@src/components/charts/BarComparisonChart.tsx
@src/components/ui/StatCard.tsx
@src/components/ui/TrendIndicator.tsx
@src/components/ui/DataRecencyTag.tsx
@src/lib/formatters.ts
@src/theme/tokens.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend type contract and mock data with input cost history</name>
  <files>src/types/sections.ts, src/data/mock/market-pulse.ts, src/components/charts/ChartLegend.tsx</files>
  <action>
**1. Extend MarketPulseData type** in `src/types/sections.ts`:
Add an optional `inputCostHistory` field to the `MarketPulseData` interface:

```typescript
/** Indexed quarterly time series for multi-line input cost chart (base 100) */
inputCostHistory?: Array<{
  period: string;
  [commodity: string]: string | number; // period is string, commodity columns are number
}>;
```

Place this field after the existing `inputCosts` field. Keep all other types untouched.

**2. Extend mock data** in `src/data/mock/market-pulse.ts`:
Add `inputCostHistory` array with 7 quarterly data points (Q1 FY24 through Q3 FY25), indexed to base 100 at Q1 FY24. Each object has `period` (string) plus numeric columns for `steel`, `copper`, `plastics`, `aluminium`:

```typescript
inputCostHistory: [
  { period: "Q1 FY24", steel: 100, copper: 100, plastics: 100, aluminium: 100 },
  { period: "Q2 FY24", steel: 102, copper: 105, plastics: 101, aluminium: 103 },
  { period: "Q3 FY24", steel: 99,  copper: 108, plastics: 98,  aluminium: 106 },
  { period: "Q4 FY24", steel: 104, copper: 110, plastics: 96,  aluminium: 108 },
  { period: "Q1 FY25", steel: 106, copper: 112, plastics: 97,  aluminium: 111 },
  { period: "Q2 FY25", steel: 104, copper: 106, plastics: 99,  aluminium: 107 },
  { period: "Q3 FY25", steel: 108, copper: 113, plastics: 97,  aluminium: 110 },
],
```

Values should be plausible: steel and copper trending up, plastics dipping, aluminium rising. The final quarter values should be consistent with the existing QoQ/YoY change percentages in `inputCosts`.

**3. Create ChartLegend component** at `src/components/charts/ChartLegend.tsx`:
A simple custom Recharts legend matching the design system. Interface:

```typescript
interface LegendPayload {
  value: string;
  color?: string;
}

interface ChartLegendProps {
  payload?: LegendPayload[];
}
```

Renders a `flex flex-wrap gap-md justify-center mt-sm` container. Each entry is a small colored dot (`w-2 h-2 rounded-full`) + `text-xs text-text-secondary` label. Export as named export `ChartLegend`.

Use `as any` cast when passing to Recharts `<Legend content={...}>` to work around known Recharts v3 Legend typing issues (GitHub issue #2909).
  </action>
  <verify>
Run `npx tsc --noEmit` -- zero TypeScript errors. Verify `inputCostHistory` field exists in the MarketPulseData type. Verify the mock data default export includes the new `inputCostHistory` array with 7 entries.
  </verify>
  <done>MarketPulseData type has `inputCostHistory` optional field. Mock data has 7-quarter time series. ChartLegend component exists and exports correctly.</done>
</task>

<task type="auto">
  <name>Task 2: Build Market Pulse section with 4 sub-sections in dashboard grid</name>
  <files>src/sections/market-pulse/MarketPulse.tsx, src/sections/market-pulse/DemandSignals.tsx, src/sections/market-pulse/InputCostTrends.tsx, src/sections/market-pulse/MarginOutlook.tsx, src/sections/market-pulse/ChannelMix.tsx</files>
  <action>
Replace the Phase 2 placeholder in `MarketPulse.tsx` with a full dashboard grid layout. Create 4 sub-section components. The main component must retain `export default function MarketPulse()` (React.lazy requires default export).

**MarketPulse.tsx** (main orchestrator):
- Keep the existing `useFilteredData<MarketPulseData>("market-pulse")` call, loading/error handling, and the header with `DataRecencyTag`.
- Remove the placeholder content (counts, active filters text, "Phase 5" italic text).
- Layout structure (per RESEARCH.md Pattern 1 -- dashboard grid):
  ```
  <div className="p-md space-y-md">
    {/* Header row with title + DataRecencyTag */}
    {/* Demand signals: 4-column StatCard grid */}
    <DemandSignals signals={data.demandSignals} />
    {/* Charts row: 2-column grid */}
    <div className="grid grid-cols-2 gap-md">
      <InputCostTrends costs={data.inputCosts} history={data.inputCostHistory} />
      <ChannelMix channels={data.channelMix} />
    </div>
    {/* Margin outlook: full-width narrative */}
    <MarginOutlook outlook={data.marginOutlook} />
  </div>
  ```
- Delete the `getActiveFilterSummary` helper function (no longer needed).

**DemandSignals.tsx**:
- Props: `{ signals: MarketPulseData['demandSignals'] }`
- Render a `grid grid-cols-4 gap-md` container (on smaller screens consider `grid-cols-2` via `sm:grid-cols-2 lg:grid-cols-4` for responsiveness).
- Each signal renders a `StatCard` with:
  - `label={signal.channel}`
  - `value={signal.magnitude}` (already formatted string like "+22% volume YoY")
  - `trend={{ direction: signal.direction, label: signal.signal }}` -- the signal text as the trend label (truncate with `line-clamp-2` on the parent if needed, but StatCard trend label is `text-xs` so it should be fine)
- Add a small `h3` heading: "Demand Signals" in `text-xs font-medium text-text-secondary uppercase tracking-wide mb-sm`.

**InputCostTrends.tsx**:
- Props: `{ costs: MarketPulseData['inputCosts'], history?: MarketPulseData['inputCostHistory'] }`
- Wrapped in a `bg-surface-raised border border-surface-overlay rounded p-md` panel.
- Panel heading: "Input Cost Trends" in `text-xs font-medium text-text-secondary uppercase tracking-wide`.
- If `history` exists and has data, render a `TrendLineChart` with:
  - `data={history}` (already in the right shape: array of period objects with commodity columns)
  - `xDataKey="period"`
  - `lines` array mapping the 4 commodities to chart colors:
    - `{ dataKey: "steel", colorVar: "--color-chart-1", label: "Steel (HR Coil)" }`
    - `{ dataKey: "copper", colorVar: "--color-chart-2", label: "Copper (LME)" }`
    - `{ dataKey: "plastics", colorVar: "--color-chart-3", label: "Plastics (ABS)" }`
    - `{ dataKey: "aluminium", colorVar: "--color-chart-4", label: "Aluminium (LME)" }`
  - Add a `<Legend content={ChartLegend as any} />` inside the chart. Since TrendLineChart does not expose Legend natively, render the ChartLegend manually below the chart by mapping the same lines config into a legend display.
- Below the chart, render a summary row showing each commodity's QoQ and YoY changes from the `costs` array. Use `formatGrowthRate` from `src/lib/formatters.ts` to format decimal values (e.g., `0.045` becomes `"+4.5% QoQ"`). Display as a compact `grid grid-cols-2 gap-sm` or `grid grid-cols-4 gap-sm` of small items, each showing commodity name, a `TrendIndicator` for direction, and `formatGrowthRate(cost.qoqChange, "QoQ")` / `formatGrowthRate(cost.yoyChange, "YoY")` text.
- If `history` is missing/empty, fall back to just showing the QoQ/YoY summary row (no chart).

**MarginOutlook.tsx**:
- Props: `{ outlook: string }`
- Wrapped in a `bg-surface-raised border border-surface-overlay rounded p-md` panel.
- Panel heading: "Margin Outlook" in `text-xs font-medium text-text-secondary uppercase tracking-wide`.
- Render the `outlook` string as a `text-xs text-text-primary leading-relaxed` paragraph. The mock data contains a detailed narrative paragraph with specific company names and figures -- render it as-is.
- Add a subtle left border accent: `border-l-2 border-l-neutral` on the paragraph container for visual distinction.

**ChannelMix.tsx**:
- Props: `{ channels: MarketPulseData['channelMix'] }`
- Wrapped in a `bg-surface-raised border border-surface-overlay rounded p-md` panel.
- Panel heading: "Channel Mix Shifts" in `text-xs font-medium text-text-secondary uppercase tracking-wide`.
- Transform channel data for BarComparisonChart:
  ```typescript
  const chartData = channels.map(ch => ({
    channel: ch.channel,
    previous: ch.previousSharePct,
    current: ch.currentSharePct,
  }));
  const bars: BarConfig[] = [
    { dataKey: "previous", colorVar: "--color-chart-5", label: "Previous Period" },
    { dataKey: "current", colorVar: "--color-chart-1", label: "Current Period" },
  ];
  ```
- Render `<BarComparisonChart data={chartData} bars={bars} xDataKey="channel" />` with `stacked={false}` (default, side-by-side per RESEARCH.md recommendation).
- Below the chart, render a compact data table showing each channel's current share, previous share, and change (current - previous) with `TrendIndicator`. Format percentages with `formatPercent`.
- Render ChartLegend manually below the chart with the two bar colors/labels.

**Important constraints:**
- Do NOT add `company` fields to any Market Pulse data. The demand signals use `channel`, input costs use `commodity`, channel mix uses `channel`. This ensures `useFilteredData` company filtering is a no-op for Market Pulse (sector-wide view per locked decision).
- Use only existing chart components (TrendLineChart, BarComparisonChart) -- do NOT create new chart wrappers.
- Use formatters from `src/lib/formatters.ts` for all numeric display (formatGrowthRate, formatPercent).
- Use existing UI primitives (StatCard, TrendIndicator, DataRecencyTag) -- do NOT recreate them.
  </action>
  <verify>
Run `npx tsc --noEmit` -- zero TypeScript errors. Run `npm run dev` and navigate to the Market Pulse section. Verify:
1. Four demand signal StatCards visible in a grid row with channel names, magnitudes, and trend arrows.
2. Multi-line chart shows 4 commodity trend lines over 7 quarters with a legend.
3. QoQ and YoY changes displayed below the chart for each commodity.
4. Channel mix bar chart shows side-by-side bars for current vs previous share.
5. Margin outlook paragraph renders the full narrative text.
6. Activating a company filter does NOT change Market Pulse data (sector-wide view).
  </verify>
  <done>Market Pulse section displays all 4 sub-sections (demand signals, input costs with chart, margin outlook, channel mix with chart) in a dashboard grid. No company filtering on Market Pulse data. Requirements MRKT-01, MRKT-02, MRKT-03, MRKT-04 satisfied.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with zero errors
- `npm run dev` shows Market Pulse section with all 4 sub-sections rendered
- Demand signals: 4 StatCards with trend arrows (MRKT-01)
- Input costs: Multi-line TrendLineChart + QoQ/YoY summary (MRKT-02)
- Margin outlook: Full narrative paragraph with visual treatment (MRKT-03)
- Channel mix: Side-by-side BarComparisonChart + data table (MRKT-04)
- Company filter active does NOT affect Market Pulse display (sector-wide)
- All formatting uses formatters.ts functions (Indian number format, growth rates)
</verification>

<success_criteria>
Market Pulse section renders 4 sub-sections in a dashboard grid layout: demand signal StatCards, multi-line input cost trend chart with QoQ/YoY labels, margin outlook narrative, and channel mix bar chart. The section is sector-wide and unaffected by company filters. Requirements MRKT-01 through MRKT-04 are complete.
</success_criteria>

<output>
After completion, create `.planning/phases/05-market-context-and-operations/05-01-SUMMARY.md`
</output>
