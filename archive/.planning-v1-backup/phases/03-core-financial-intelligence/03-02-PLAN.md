---
phase: 03-core-financial-intelligence
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/types/sections.ts
  - src/types/financial.ts
  - src/data/mock/financial.ts
  - src/sections/financial/FinancialPerformance.tsx
  - src/sections/financial/MetricsTable.tsx
  - src/sections/financial/MetricsTableRow.tsx
  - src/sections/financial/VarianceAnalysis.tsx
  - src/sections/financial/ComparisonView.tsx
  - src/sections/financial/ComparisonChart.tsx
  - src/sections/financial/useSortedData.ts
autonomous: true

must_haves:
  truths:
    - "User sees a sortable metrics table with columns: Company, Revenue Growth YoY, EBITDA Margin, Working Capital Days, ROCE, Debt/Equity -- each company tagged with PerformanceTag"
    - "User can click any column header to sort ascending/descending with visual sort indicator"
    - "User can select 2-5 companies via inline checkboxes for side-by-side comparison"
    - "Comparison view shows time-series TrendLineChart for each metric with QoQ/YoY toggle"
    - "Every metric displays source attribution (e.g. 'BSE filing Q3 FY25') via tooltip"
    - "Each company has expandable AI variance analysis narrative explaining metric changes"
    - "Table responds to global filters from FilterBar (company, sub-category, performance tier)"
  artifacts:
    - path: "src/sections/financial/FinancialPerformance.tsx"
      provides: "Main financial section replacing placeholder"
      min_lines: 60
    - path: "src/sections/financial/MetricsTable.tsx"
      provides: "Sortable table with checkboxes and expandable rows"
      min_lines: 80
    - path: "src/sections/financial/MetricsTableRow.tsx"
      provides: "Single company row with checkbox, metrics, expand trigger"
      min_lines: 60
    - path: "src/sections/financial/VarianceAnalysis.tsx"
      provides: "Expandable row content with AI narrative and source"
      min_lines: 20
    - path: "src/sections/financial/ComparisonView.tsx"
      provides: "Side-by-side comparison with period toggle"
      min_lines: 50
    - path: "src/sections/financial/ComparisonChart.tsx"
      provides: "Single metric trend chart for selected companies"
      min_lines: 30
    - path: "src/sections/financial/useSortedData.ts"
      provides: "Sorting hook with useMemo + useState"
      min_lines: 30
    - path: "src/data/mock/financial.ts"
      provides: "Enriched mock data with quarterly history per company"
      contains: "history"
    - path: "src/types/sections.ts"
      provides: "Updated FinancialPerformanceData with history array"
      contains: "QuarterlySnapshot"
  key_links:
    - from: "src/sections/financial/FinancialPerformance.tsx"
      to: "useFilteredData"
      via: "hook call"
      pattern: "useFilteredData.*financial"
    - from: "src/sections/financial/MetricsTable.tsx"
      to: "useSortedData"
      via: "sorting hook"
      pattern: "useSortedData"
    - from: "src/sections/financial/MetricsTableRow.tsx"
      to: "PerformanceTag"
      via: "component import"
      pattern: "PerformanceTag"
    - from: "src/sections/financial/ComparisonChart.tsx"
      to: "TrendLineChart"
      via: "chart wrapper"
      pattern: "TrendLineChart"
    - from: "src/sections/financial/MetricsTableRow.tsx"
      to: "Collapsible"
      via: "expandable variance row"
      pattern: "Collapsible"
    - from: "src/sections/financial/ComparisonView.tsx"
      to: "Tabs"
      via: "QoQ/YoY period toggle"
      pattern: "Tabs"
---

<objective>
Build the Financial Performance Tracker -- a sortable, filterable metrics table for 16 Consumer Durables companies with expandable variance analysis, inline comparison selection, and time-series trend charts. Replace the Phase 2 placeholder with a full-featured financial analysis module.

Purpose: This is the analytical core of the product. Consulting partners use this table daily to scan financial health across the coverage universe, compare peer companies, and identify BD targets from metric anomalies.
Output: Fully functional Financial Performance section with sortable table, expandable variance rows, company comparison with trend charts, and source attribution.
</objective>

<execution_context>
@/Users/prateekkurkanji/.claude/get-shit-done/workflows/execute-plan.md
@/Users/prateekkurkanji/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-core-financial-intelligence/03-CONTEXT.md
@.planning/phases/03-core-financial-intelligence/03-RESEARCH.md
@.planning/phases/03-core-financial-intelligence/03-01-SUMMARY.md
@src/types/sections.ts
@src/types/common.ts
@src/types/financial.ts
@src/data/mock/financial.ts
@src/sections/financial/FinancialPerformance.tsx
@src/hooks/use-filtered-data.ts
@src/components/ui/PerformanceTag.tsx
@src/components/ui/DataRecencyTag.tsx
@src/components/ui/SectionSkeleton.tsx
@src/components/ui/TrendIndicator.tsx
@src/components/charts/TrendLineChart.tsx
@src/lib/formatters.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend types and mock data for time-series financial history</name>
  <files>src/types/sections.ts, src/types/financial.ts, src/data/mock/financial.ts</files>
  <action>
1. In `src/types/financial.ts`, add a `QuarterlySnapshot` interface:
   ```typescript
   /** Historical quarterly data point for trend charts */
   export interface QuarterlySnapshot {
     period: string;              // "Q1 FY24", "Q2 FY24", etc.
     revenueGrowthYoY: number;   // decimal (0.125 = 12.5%)
     ebitdaMargin: number;       // decimal (0.18 = 18%)
     workingCapitalDays: number;  // integer days
     roce: number;               // decimal
     debtEquity: number;         // ratio
   }
   ```

2. In `src/types/sections.ts`, add `QuarterlySnapshot` import from `./financial` and extend the `FinancialPerformanceData` company entry with a `history` array:
   ```typescript
   import type { FinancialMetrics, QuarterlySnapshot } from "./financial";
   // ...
   companies: Array<{
     id: string;
     name: string;
     ticker: string;
     metrics: FinancialMetrics;
     performance: PerformanceLevel;
     varianceAnalysis: string;
     source: string;
     history: QuarterlySnapshot[];  // Last 6 quarters for trend charts
   }>;
   ```
   Ensure the existing `FinancialMetrics` import in sections.ts is updated to also import `QuarterlySnapshot`. Do NOT modify `ExecutiveSnapshotData` (that was handled in 03-01).

3. In `src/data/mock/financial.ts`, add `history` array to each of the 16 company entries. Generate 6 quarters of plausible historical data (Q2 FY24 through Q3 FY25, with Q3 FY25 matching the current snapshot metrics). Data should be realistic:
   - For outperformers (Voltas, Blue Star, Havells, Amber, Dixon, Daikin): show improving trends
   - For inline companies (Crompton, Symphony, Bajaj, V-Guard, TTK): show stable/mixed trends
   - For underperformers (Whirlpool, Orient, Butterfly, JCH, IFB): show deteriorating trends
   - Each quarter's metrics should be slightly different from adjacent quarters (not identical)
   - Working capital days should fluctuate by 3-8 days between quarters
   - Revenue growth should vary by 1-3 percentage points between quarters
   - EBITDA margins should vary by 0.5-2 percentage points between quarters

   Import `QuarterlySnapshot` from the types file. The history array goes AFTER the existing `source` field in each company entry.
  </action>
  <verify>Run `npx tsc --noEmit` -- zero errors. All 16 companies have a `history` array with 6 entries each.</verify>
  <done>QuarterlySnapshot type is defined. FinancialPerformanceData includes history array. All 16 companies have 6 quarters of plausible trend data with Q3 FY25 matching current snapshot metrics.</done>
</task>

<task type="auto">
  <name>Task 2: Build Financial Performance section components</name>
  <files>src/sections/financial/FinancialPerformance.tsx, src/sections/financial/MetricsTable.tsx, src/sections/financial/MetricsTableRow.tsx, src/sections/financial/VarianceAnalysis.tsx, src/sections/financial/ComparisonView.tsx, src/sections/financial/ComparisonChart.tsx, src/sections/financial/useSortedData.ts</files>
  <action>
Create 6 new component files and replace the FinancialPerformance placeholder. All use existing design tokens and Phase 1 primitives. No new dependencies.

**src/sections/financial/useSortedData.ts:**
- Custom hook following RESEARCH.md Pattern 1 exactly
- `useState` for sort config: `{ field: SortField, direction: "asc" | "desc" }`
- `SortField` type: `"name" | "revenueGrowthYoY" | "ebitdaMargin" | "workingCapitalDays" | "roce" | "debtEquity"`
- `useMemo` derives sorted array from companies + sortConfig
- For `"name"` field: string comparison via localeCompare
- For metric fields: access `company.metrics[field]` for numeric comparison
- Default sort: `{ field: "name", direction: "asc" }`
- `toggleSort(field)`: same field toggles direction, new field defaults to `"asc"` (except for name which defaults to `"asc"`, metrics default to `"desc"` since users typically want highest-first for financial metrics)
- Export: `{ sorted, sortConfig, toggleSort }`

**src/sections/financial/VarianceAnalysis.tsx:**
- Receives props: `{ narrative: string; source: string }`
- Renders in a compact block with `bg-surface-raised/30 rounded p-sm`
- AI narrative: xs italic text-text-secondary
- Source attribution at bottom: "Source:" label in 10px font-medium + source text in 10px text-text-muted
- Keep this component very simple -- just styled text

**src/sections/financial/MetricsTableRow.tsx:**
- Receives props: `{ company, isSelected, onToggleSelect, isExpanded, onToggleExpand }`
- Uses CSS Grid row (inherits grid-template-columns from parent MetricsTable)
- Cells:
  1. Checkbox using Radix `Checkbox` from `"radix-ui"`: small (14x14), checked state matches `isSelected`, `onCheckedChange` calls `onToggleSelect(company.id)`. If disabled (max 5 reached and not selected), show reduced opacity.
  2. Company name: text-text-primary font-medium xs, with `PerformanceTag level={company.performance} compact` next to it
  3. Revenue Growth YoY: right-aligned, use `formatGrowthRate(company.metrics.revenueGrowthYoY)` from formatters.ts. Show value with color coding: positive = text-positive, negative = text-negative
  4. EBITDA Margin: right-aligned, `formatPercent(company.metrics.ebitdaMargin * 100)`. No sign needed for margin (always positive), display as `(company.metrics.ebitdaMargin * 100).toFixed(1) + "%"`
  5. Working Capital Days: right-aligned, `company.metrics.workingCapitalDays` + " days"
  6. ROCE: right-aligned, same format as EBITDA margin `(company.metrics.roce * 100).toFixed(1) + "%"`
  7. Debt/Equity: right-aligned, `company.metrics.debtEquity.toFixed(2) + "x"`
  8. Source attribution: use Radix `Tooltip` from `"radix-ui"` wrapping a small "src" text link. Tooltip content shows `company.source`. Follow the SourceAttribution pattern from RESEARCH.md exactly.
  9. Expand chevron: button with rotate animation, `data-[state=open]:rotate-90` -- toggles variance analysis
- Below the data row: conditionally render VarianceAnalysis inside a Collapsible-controlled section when `isExpanded` is true. Since we are using CSS Grid (not HTML table), we can wrap each row + its expandable content in a div. The expanded content spans all columns using `grid-column: 1 / -1`.
- Row hover: `hover:bg-surface-raised/50` transition
- Row border: `border-b border-surface-overlay`

**src/sections/financial/MetricsTable.tsx:**
- Receives props: `{ companies, selectedIds, onToggleSelect, maxSelected }`
- Uses `useSortedData` hook on companies
- CSS Grid table with `grid-template-columns: 32px minmax(140px, 1.5fr) repeat(5, minmax(75px, 1fr)) 36px 32px`
  - 32px = checkbox, 140px+ = company name, 5 metric columns, 36px = source, 32px = expand
- Header row: render a SortableHeader-style element for each column
  - Each header is a `<button>` (for keyboard accessibility per RESEARCH.md pitfall 3)
  - Active sort: text-brand-accent with directional triangle arrow
  - Inactive sort: text-text-muted with diamond
  - Metric headers: right-aligned (`text-right justify-end`)
  - Company header: left-aligned
  - Checkbox column header: small "Select" text or just empty
  - Source column header: empty
  - Expand column header: empty
- Body: map over `sorted` companies, render MetricsTableRow for each
- Track expanded row state: `useState<string | null>` (only one row expanded at a time)
- Selection counter: show "{n} of {maxSelected} selected" in xs text-text-muted below the table when any companies are selected
- Comparison hint: when 1 company is selected, show "Select 1 more to compare" in xs text-brand-accent

**src/sections/financial/ComparisonChart.tsx:**
- Receives props: `{ companies: Array<{ id, name, history }>, metric: keyof QuarterlySnapshot (excluding "period"), label: string }`
- Derives chart data via `useMemo`: maps first company's history periods as x-axis, plots each company as a line
- Uses `TrendLineChart` from Phase 1:
  - `data`: array of `{ period, [companyId]: metricValue, ... }` objects
  - `lines`: map each company to `{ dataKey: company.id, colorVar: "--color-chart-{index+1}", label: company.name }`
  - `xDataKey`: "period"
  - `height`: 200
- Chart data is derived from `selectedForComparison` IDs against ORIGINAL (unsorted) data per RESEARCH.md pitfall 5 -- preventing chart flicker on sort

**src/sections/financial/ComparisonView.tsx:**
- Receives props: `{ companies: Array<{ id, name, history }> }` (already filtered to selected companies)
- Uses Radix `Tabs` from `"radix-ui"` for QoQ/YoY period toggle (following RESEARCH.md Pattern 4 exactly)
- Tab triggers: "Year over Year" (value="YoY") and "Quarter over Quarter" (value="QoQ") with brand-accent active styling
- Tab content: render 5 ComparisonChart components, one for each metric:
  1. Revenue Growth YoY -- label "Revenue Growth (%)"
  2. EBITDA Margin -- label "EBITDA Margin (%)"
  3. Working Capital Days -- label "Working Capital (Days)"
  4. ROCE -- label "ROCE (%)"
  5. Debt/Equity -- label "Debt/Equity Ratio"
- Layout: 2-column grid for charts on wide viewports, 1 column on narrow
- For QoQ tab: transform the history data to show quarter-over-quarter change rather than the absolute values. Calculate QoQ delta for each metric: `(current - previous) / |previous|` for ratio metrics. For workingCapitalDays, show absolute change: `current - previous`.
- Each chart has a label (xs font-medium text-text-primary) above it
- Section header: "Company Comparison" with company count badge

**src/sections/financial/FinancialPerformance.tsx (REPLACE placeholder):**
- Keep `export default function` pattern (React.lazy)
- Use `useFilteredData<FinancialPerformanceData>("financial")` exactly like current placeholder
- Loading: `<SectionSkeleton variant="table" />`
- Error: `throw error`
- Local state: `const [selectedForComparison, setSelectedForComparison] = useState<string[]>([])`
- Toggle function: per RESEARCH.md Pattern 3 -- add/remove with max 5 clamp, disable unchecked checkboxes when 5 selected
- Layout (top to bottom):
  1. Header row: "Financial Performance" heading + DataRecencyTag
  2. MetricsTable with `data.companies`, selection state, toggle handler, maxSelected=5
  3. Conditional: when `selectedForComparison.length >= 2`, render ComparisonView
     - CRITICAL: derive comparison companies from `rawData.companies` (original unfiltered data) filtered by selectedForComparison IDs, NOT from sorted data -- prevents chart re-render on sort (RESEARCH.md pitfall 5)
- Remove placeholder text and getActiveFilterSummary helper
  </action>
  <verify>
1. Run `npx tsc --noEmit` -- zero type errors
2. Run `npm run build` -- build succeeds with no errors
3. Run `npx vitest run` -- all existing tests pass (no regressions)
  </verify>
  <done>
- Financial Performance renders sortable metrics table for all 16 companies with 6 sortable columns
- Each company has PerformanceTag (outperform/inline/underperform) and source attribution tooltip
- Clicking column headers sorts ascending/descending with visual indicator
- Inline checkboxes allow selecting 2-5 companies for comparison (clamped at 5)
- Comparison view shows 5 trend charts with QoQ/YoY toggle using Radix Tabs
- Each row has expandable variance analysis narrative
- Table responds to global FilterBar filters (company, sub-category, performance tier)
- Requirements covered: FINP-01 (metrics table), FINP-02 (comparison), FINP-03 (trend charts), FINP-04 (PerformanceTag), FINP-05 (source attribution), FINP-06 (variance analysis), FINP-07 (sort and filter)
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `npx tsc --noEmit` passes with zero errors
2. `npm run build` succeeds
3. `npx vitest run` -- all existing tests pass
4. Financial Performance section renders 16-company metrics table
5. All 6 columns are sortable with visual sort indicators
6. Clicking a company checkbox + selecting a second shows ComparisonView with trend charts
7. QoQ/YoY tab toggle changes chart data display
8. Expanding a row shows variance analysis narrative with source attribution
9. Global filters (FilterBar) reduce the table to matching companies
10. Selecting 5 companies disables remaining unchecked checkboxes
</verification>

<success_criteria>
- FINP-01: Metrics table shows Revenue Growth, EBITDA Margin, Working Capital Days, ROCE, Debt/Equity for all 16 companies
- FINP-02: 2-5 company side-by-side comparison works via inline checkbox selection
- FINP-03: Time-series trend charts show 6 quarters of data with QoQ/YoY toggle
- FINP-04: Each company tagged with PerformanceTag (outperform/inline/underperform)
- FINP-05: Source attribution on every metric via Radix Tooltip
- FINP-06: AI variance analysis narrative expandable per company
- FINP-07: Table sortable by any column, filterable via global FilterBar
- No new dependencies -- all from existing radix-ui, Recharts wrappers, clsx, hooks, formatters
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-financial-intelligence/03-02-SUMMARY.md`
</output>
